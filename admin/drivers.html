<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Driver Management - TourTheLakes Admin</title>
  <!-- Tailwind CSS via CDN for styling -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Header / Logout -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Driver Management</h1>
    <button
      id="logout-btn"
      class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
    >Logout</button>
  </header>

  <main class="p-6">
    <!-- Section: List of Drivers -->
    <section class="mb-8">
      <h2 class="text-lg font-semibold mb-4">Existing Drivers</h2>
      <div id="drivers-list" class="space-y-4">
        <!-- JS will inject driver cards here -->
      </div>
    </section>

    <!-- Section: Add New Driver -->
    <section>
      <h2 class="text-lg font-semibold mb-4">Add New Driver</h2>
      <form id="add-driver-form" class="bg-white p-4 rounded shadow space-y-4 max-w-md">
        <div>
          <label class="block text-sm font-medium">Name</label>
          <input id="new-name" class="mt-1 block w-full border rounded-md p-2" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Door Card #</label>
          <input id="new-doorcard" class="mt-1 block w-full border rounded-md p-2" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Password</label>
          <input id="new-password" type="password" class="mt-1 block w-full border rounded-md p-2" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Vehicle</label>
          <input id="new-vehicle" class="mt-1 block w-full border rounded-md p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Capacity</label>
          <input id="new-capacity" type="number" min="1" class="mt-1 block w-full border rounded-md p-2" />
        </div>
        <button
          type="submit"
          class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
        >Add Driver</button>
        <p id="add-error" class="text-red-500 mt-2"></p>
      </form>
    </section>
  </main>

  <!-- 1) Firebase config (your keys) -->
  <script src="../firebase-config.js"></script>
  <!-- 2) Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- 3) Driver CRUD logic -->
  <script>
    // Initialize Firebase
    firebase.initializeApp(window.firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Redirect to login if not authenticated
    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = 'login.html';
    });

    // Logout button
    document.getElementById('logout-btn').addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      });
    });

    const driversRef = db.ref('drivers');
    const listEl = document.getElementById('drivers-list');
    const addForm = document.getElementById('add-driver-form');
    const addErrorEl = document.getElementById('add-error');

    // Render drivers when data changes
    driversRef.on('value', snapshot => {
      listEl.innerHTML = ''; // clear
      snapshot.forEach(child => {
        const id = child.key;
        const d = child.val();
        // Create card
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow flex justify-between items-center';
        card.innerHTML = `
          <div>
            <p><strong>${d.name}</strong> (Card: ${d.doorCard})</p>
            <p>Vehicle: ${d.vehicle || '–'} › Capacity: ${d.capacity || '–'}</p>
          </div>
          <div class="space-x-2">
            <button data-action="edit" data-id="${id}" class="px-3 py-1 bg-yellow-400 rounded hover:bg-yellow-500">Edit</button>
            <button data-action="delete" data-id="${id}" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">Delete</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    });

    // Handle Edit/Delete clicks
    listEl.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      if (btn.dataset.action === 'delete') {
        if (confirm('Are you sure you want to delete this driver?')) {
          driversRef.child(id).remove();
        }
      }
      if (btn.dataset.action === 'edit') {
        // Simple prompt-based edit
        const name = prompt('New name:', '');
        if (name === null) return;
        const doorCard = prompt('New Door Card #:', '');
        if (doorCard === null) return;
        const vehicle = prompt('New vehicle (or leave blank):', '');
        if (vehicle === null) return;
        const capacity = prompt('New capacity (or leave blank):', '');
        if (capacity === null) return;
        const updates = { name, doorCard };
        if (vehicle) updates.vehicle = vehicle;
        if (capacity) updates.capacity = Number(capacity);
        driversRef.child(id).update(updates);
      }
    });

    // Handle Add Driver form submit
    addForm.addEventListener('submit', e => {
      e.preventDefault();
      addErrorEl.textContent = '';
      const name = document.getElementById('new-name').value.trim();
      const doorCard = document.getElementById('new-doorcard').value.trim();
      const password = document.getElementById('new-password').value;
      const vehicle = document.getElementById('new-vehicle').value.trim();
      const capacity = document.getElementById('new-capacity').value;

      // Basic validation
      if (!name || !doorCard || !password) {
        addErrorEl.textContent = 'Please fill in name, door card and password.';
        return;
      }
      // Push new driver
      driversRef.push({
        name,
        doorCard,
        password,
        vehicle: vehicle || null,
        capacity: capacity ? Number(capacity) : null
      }).then(() => {
        addForm.reset();
      }).catch(err => {
        addErrorEl.textContent = err.message;
      });
    });
  </script>
</body>
</html>
