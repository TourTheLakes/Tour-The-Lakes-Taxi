<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Diary</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #driverList {
      margin-top: 20px;
    }
    .driverCard {
      background: #fff;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .timeline {
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0;
    }
    .timeline li {
      margin: 5px 0;
    }
    .time {
      font-weight: bold;
      width: 60px;
      display: inline-block;
    }
    .label {
      display: inline-block;
    }
    #returnButton {
      display: block;
      margin: 30px auto 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Diary Page</h1>
  <div id="controls">
    <input type="date" id="datePicker">
  </div>
  <div id="driverList"></div>
  <button id="returnButton" onclick="window.location.href='Office.html'">
    Return to Office
  </button>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.appspot.com",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
      measurementId: "G-W6JY1LZXTP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const datePicker = document.getElementById('datePicker');
    const driverList = document.getElementById('driverList');

    function setToday() {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      datePicker.value = `${y}-${m}-${d}`;
    }

    function toMins(t) {
      const p = t.split(':');
      return parseInt(p[0])*60 + parseInt(p[1]);
    }

    function loadDiary(date) {
      driverList.innerHTML = '';
      db.ref('driversProfile').once('value', snap => {
        snap.forEach(dr => {
          const driverId = dr.key;
          const name     = dr.val().name;
          const card     = document.createElement('div');
          card.className = 'driverCard';
          card.innerHTML = `<strong>${name}</strong>`;
          driverList.appendChild(card);

          // gather shift and bookings
          db.ref(`shifts/${driverId}/${date}`).once('value', shiftSnap => {
            const shift = shiftSnap.val() || {};
            db.ref(`bookings/${driverId}/${date}`).once('value', bkSnap => {
              const events = [];
              // shift start/end
              if (shift.shiftStart) events.push({time: shift.shiftStart, label: 'Shift start'});
              if (shift.breakStart) events.push({time: shift.breakStart, label: 'Break start'});
              if (shift.breakEnd)   events.push({time: shift.breakEnd,   label: 'Break end'});
              if (shift.shiftEnd)   events.push({time: shift.shiftEnd,   label: 'Shift end'});

              // bookings
              bkSnap.forEach(bc => {
                const b = bc.val();
                if (b.bookingTime)     events.push({time: b.bookingTime,    label: `Pickup â†’`});
                if (b.bookingEndTime)  events.push({time: b.bookingEndTime, label: `Drop-off done`});
                if (b.returnTime)      events.push({time: b.returnTime,     label: `Return to base`});
              });

              // sort by time
              events.sort((a, b) => toMins(a.time) - toMins(b.time));

              // render timeline
              const ul = document.createElement('ul');
              ul.className = 'timeline';
              events.forEach(ev => {
                const li = document.createElement('li');
                li.innerHTML = 
                  `<span class="time">${ev.time}</span> ` +
                  `<span class="label">${ev.label}</span>`;
                ul.appendChild(li);
              });
              card.appendChild(ul);
            });
          });
        });
      });
    }

    datePicker.addEventListener('change', () => {
      loadDiary(datePicker.value);
    });

    window.addEventListener('DOMContentLoaded', () => {
      setToday();
      loadDiary(datePicker.value);
    });
  </script>
</body>
</html>
