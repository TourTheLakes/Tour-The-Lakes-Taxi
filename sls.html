<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" />
  <link rel="shortcut icon" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" type="image/png" />
  <link rel="mask-icon" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" color="#d8a04e" />

  <title>Tour The Lakes — Six Lakes Splendour</title>
  <meta name="description" content="Placeholder page for Tour The Lakes — individual tour details and reservations." />
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#0e1416" />
  <meta name="color-scheme" content="dark light" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet" />

<style>
:root {
  --bg: #0e1416;
  --surface: #1a2023;
  --text: #e8e5df;
  --muted: #a5aaa9;
  --gold: #d8a04e;
  --tarn: #4b8ca7;
  --shadow: rgba(0,0,0,0.5);
  --radius: 16px;
  --transition: 0.5s ease;
  --seat-size: 36px;
}

/* ========== RESET / BASICS ========== */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; scroll-behavior: smooth; }
body {
  font-family: "Work Sans", sans-serif;
  color: var(--text);
  background: var(--bg);
  overflow-x: hidden;
}

/* ========== HEADER ========== */
header {
  position: fixed;
  top: 0; left: 0; width: 100%;
  background: rgba(14, 20, 22, 0.6);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
  padding: 12px 60px;
  z-index: 100;
}

.brand {
  font-family: "Playfair Display", serif;
  font-size: 1.8rem;
  color: var(--gold);
  letter-spacing: 1px;
  text-decoration: none;
  transition: color var(--transition);
}
.brand:hover { color: var(--tarn); }

nav a {
  margin-left: 28px;
  text-decoration: none;
  color: var(--muted);
  transition: color var(--transition);
}
nav a:hover { color: var(--gold); }

/* ========== HERO ========== */
.hero {
  min-height: 100vh;
  background: linear-gradient(rgba(14,14,14,0.4), rgba(14,14,14,0.8)),
  url('https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/DSC_0092.JPG')
  center/cover no-repeat;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: var(--text);
  padding: 0 20px;
}

.hero h1 {
  font-family: "Playfair Display", serif;
  font-size: clamp(2.8rem, 6vw, 5rem);
  font-weight: 700;
  letter-spacing: 1px;
  color: var(--gold);
  text-shadow: 0 2px 20px var(--shadow);
  animation: fadeUp 1.5s ease forwards;
  margin-bottom: 24px;
}

.hero p {
  font-size: 1.2rem;
  margin-bottom: 24px;
  color: var(--muted);
  animation: fadeUp 2s ease forwards;
}

#book {
  background: linear-gradient(rgba(14,14,14,0.4), rgba(14,14,14,0.8)),
  url('https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/DSC_0092.JPG')
  center/cover no-repeat;
  background-attachment: scroll;
  color: var(--text);
  backdrop-filter: blur(2px);
}

 /* ========== BOOKING FORM SECTION ========== */
#bookingform {
  background: var(--bg);
  padding: 100px 10vw;
}

#bookingform h2 {
  font-family: "Playfair Display", serif;
  font-size: 2.4rem;
  color: var(--gold);
  margin-bottom: 40px;
  text-align: left;
}

form {
  max-width: 700px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 28px;
}

.form-group,
.form-group-inline div {
  display: flex;
  flex-direction: column;
}

label {
  font-weight: 500;
  color: var(--text);
  margin-bottom: 8px;
  font-size: 1rem;
}

label span {
  color: var(--gold);
}

input, select, textarea {
  background: var(--surface);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text);
  padding: 12px 16px;
  font-size: 1rem;
  border-radius: 8px;
  transition: border-color var(--transition), background var(--transition);
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--gold);
  background: rgba(255,255,255,0.05);
}

textarea {
  resize: none;
  min-height: 120px;
}

/* Ensure dropdown matches dark theme */
select {
  appearance: none; /* removes native OS style */
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: var(--surface);
  color: var(--text);
  border: 1px solid rgba(255,255,255,0.01);
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 1rem;
  outline: none;
  box-shadow: none;
  transition: border-color var(--transition), background var(--transition);
}

select:focus {
  border-color: var(--gold);
  background-color: var(--text);
  border: none;
}

select option {
  background-color: var(--surface);
  color: var(--text);
  border: none;
}

select::-ms-expand {
  display: none;
}

.summary {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid rgba(255,255,255,0.1);
  color: var(--muted);
  font-size: 1rem;
  line-height: 1.6;
}

.summary a#submitLink {
  display: inline-block;
  margin-top: 24px;
  color: var(--gold);
  text-decoration: none;
  font-weight: 500;
  transition: color var(--transition), opacity var(--transition);
}

.summary a#submitLink:hover {
  color: var(--tarn);
  opacity: 0.85;
} 

/* ========== SECTIONS ========== */
section {
  padding: 100px 10vw;
  text-align: left;
}
section h2 {
  font-family: "Playfair Display", serif;
  font-size: 2.5rem;
  color: var(--gold);
  margin-bottom: 20px;
}
section p {
  max-width: 760px;
  line-height: 1.7;
  font-size: 1.1rem;
  color: var(--muted);
}

/* ========== CALENDAR + BOOKING LAYOUT ========== */
.booking-wrap {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 80px;
  flex-wrap: wrap;
  margin-top: 40px;
}

.calendar-container,
.seat-wrap {
  flex: 1 1 420px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ========== CALENDAR ========== */
.calendar-container {
  margin-top: 35px;
  text-align: left;
}
  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    margin-bottom: 25px;
    width: 540px;
    margin-left: auto;
    margin-right: auto;
  }

  .month-year {
    font-family: "Playfair Display", serif;
    font-size: 1.6rem;
    color: var(--muted);
    user-select: none;
    width: 190px;
    text-align: center;
  }

.calendar-grid { width: 540px; }

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  grid-auto-rows: 32px;
  text-align: center;
  font-size: 1rem;
  color: var(--gold);
  margin-bottom: 10px;
}

.calendar-dates {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  grid-auto-rows: 32px;
  min-height: calc(6 * 32px + 5 * 12px);
  align-content: start;
  justify-items: center;
  font-size: 1rem;
  width: 540px;
}

.calendar-dates div {
  padding: 8px 0;
  font-size: 1rem;
  color: var(--text);
  user-select: none;
  text-align: center;
  font-weight: 500;
  letter-spacing: 0.5px;
  transition: color var(--transition);
}
.calendar-dates div:hover {
  color: var(--gold);
  text-shadow: 0 0 10px rgba(216,160,78,0.3);
  cursor: pointer;
}

.nav-arrow {
  background: none;
  border: none;
  font-size: 2rem;
  color: var(--muted);
  cursor: pointer;
  transition: color var(--transition);
  user-select: none;
}
.nav-arrow:hover { color: var(--gold); }

  .calendar-subtitle {
    font-family: "Work Sans", sans-serif;
    font-size: 1rem;
    color: var(--gold);
    text-align: center;
    margin-top: 24px;
    margin-bottom: 10px;
    font-weight: 500;
    text-align: center;
  }

  /* Selected calendar day highlight */
.calendar-dates div.selected {
  color: var(--gold);
  text-shadow: 0 0 10px rgba(216,160,78,0.35);
  font-weight: 600;
  border-bottom: 1px solid rgba(216,160,78,0.5);
}

/* User-chosen seat state (public booking page) */
.seat.chosen {
  background: #a66d21; /* warm amber tone to differentiate from admin green */
  box-shadow: inset 0 0 6px rgba(0,0,0,.45);
}

/* ========== SEATING GRID ========== */
.seat-wrap h3 {
  font-family: "Playfair Display", serif;
  font-size: 1.6rem;
  font-weight: 500;
  color: var(--muted);
  text-align: center;
  letter-spacing: 0.3px;
  margin-top: 40px;
  margin-bottom: 24px;
  line-height: 1.2;
  user-select: none;
}

  .seat-wrap .seat-subtitle {
    font-family: "Work Sans", sans-serif;
    font-size: 1rem;
    color: var(--gold);
    text-align: center;
    margin-bottom: 10px;
    font-weight: 500;
    text-align: center;
  }

 .auto-allocate {
  font-family: "Work Sans", sans-serif;
  font-size: 1rem;
  text-align: center;
  margin-top: 10px;
  margin-bottom: 10px;
  font-weight: 500;
  user-select: none;
}

.auto-allocate label {
  cursor: pointer;
  color: var(--gold);          /* ✅ ensure label text is gold */
  display: inline-flex;
  align-items: center;
  gap: 8px;                   /* space between box and text */
  transition: color var(--transition), text-shadow var(--transition);
}

.auto-allocate label:hover {
  color: var(--tarn);          /* same subtle hover tint as nav links */
  text-shadow: 0 0 8px rgba(216,160,78,0.25);
}

.auto-allocate input[type="checkbox"] {
  accent-color: var(--gold);
  transform: scale(1.1);
  vertical-align: middle;
  cursor: pointer;
}

.seat-grid {
  display: grid;
  grid-template-columns: repeat(4, var(--seat-size));
  grid-template-rows: repeat(4, var(--seat-size));
  gap: 18px;
  justify-content: center;
  align-content: center;
  margin-top: 30px;
 margin-bottom: 57px;
}

.seat {
  position: relative;
  width: var(--seat-size);
  height: var(--seat-size);
  border-radius: 6px;
  background: #155f1e;
  box-shadow: inset 0 0 6px rgba(0,0,0,.4);
  transition: filter var(--transition), background var(--transition);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  user-select: none;
}
.seat::before {
  content: attr(data-seat);
  position: absolute;
  color: #fff;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}
.seat:hover { filter: brightness(1.15); }
.seat.booked { background: #8b1a1a; }
.seat.empty {
  background: #2a2f31;
  opacity: 0.7;
  pointer-events: none;
  cursor: default;
}

 /* amber active tour days */
.calendar-dates div.active-date {
  color: var(--gold);
  opacity: 1 !important;
  cursor: pointer;
  font-weight: 600;
}
.calendar-dates div.active-date:hover {
  text-shadow: 0 0 10px rgba(216,160,78,0.35);
}/* amber active tour days */
.calendar-dates div.active-date {
  color: var(--gold);
  opacity: 1 !important;
  cursor: pointer;
  font-weight: 600;
}
.calendar-dates div.active-date:hover {
  text-shadow: 0 0 10px rgba(216,160,78,0.35);
} 

/* ========== FOOTER ========== */
footer {
  background: #0b0f10;
  text-align: center;
  padding: 30px;
  border-top: 1px solid rgba(255,255,255,0.1);
  font-size: 0.9rem;
  color: var(--muted);
}
footer a {
  color: var(--gold);
  text-decoration: none;
  transition: opacity var(--transition);
}
footer a:hover {
  text-decoration: underline;
  opacity: 0.85;
}

/* ========== ANIMATIONS ========== */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ========== RESPONSIVE ========== */

/* Tablets & small laptops */
@media (max-width: 900px) {
    header { padding: 12px 40px; }
  .brand { font-size: 1.5rem; }
     nav a { margin-left: 20px; font-size: 1rem; }
  .hero h1 { font-size: clamp(2.4rem, 5vw, 3.6rem); }
  .hero p { font-size: 1.05rem; padding: 0 24px; }
     section { padding: 80px 8vw; }

  .calendar-container,
  .seat-wrap { align-items: center; }
  .calendar-grid,
  .calendar-days,
  .calendar-dates { max-width: 460px; }

  .seat-grid { gap: 14px; }
}

/* Phones */
@media (max-width: 700px) {
  header {
    flex-direction: column;
    justify-content: center;
    height: auto;
    padding: 12px 0;
    text-align: center;
  }
  .brand {
    font-size: 1.5rem;
    line-height: 1.4;
    margin-bottom: 8px;
  }
  nav a {
    display: inline-block;
    margin: 0 10px;
    font-size: 0.95rem;
  }
  section { padding: 80px 6vw; }
  section h2 { text-align: center; }

  .calendar-container { align-items: center; }
  .calendar-grid,
  .calendar-days,
  .calendar-dates {
    width: 100%;
    max-width: 360px;
    gap: 8px;
    grid-auto-rows: 28px;
    font-size: 0.9rem;
  }
  .month-year { font-size: 1.3rem; }
  .nav-arrow { font-size: 1.6rem; }

  footer { font-size: 0.8rem; padding: 20px; }
}

/* Small phones */
@media (max-width: 600px) {
  .calendar-grid,
  .calendar-days,
  .calendar-dates {
    max-width: 340px;
    gap: 6px;
    grid-auto-rows: 26px;
    font-size: 0.85rem;
  }
  .month-year { font-size: 1.2rem; }
  .nav-arrow { font-size: 1.4rem; }
  footer { font-size: 0.75rem; padding: 18px; }
}

/* Smooth anchor scrolling offset */
#info,
#book { scroll-margin-top: 50px; }
</style>
  
</head>

<body>
  <header>
    <a href="index.html" class="brand">Tour The Lakes</a>
    <nav>
      <a href="index.html">Return Home</a>
      <a href="#info">Tour Info</a>
      <a href="#book">Book</a>
    </nav>
  </header>

  <section class="hero">
    <h1>Six Lakes Splendour</h1>
    <p>Half-day tour exploring six of the Lake District’s most distinctive waters.</p>
  </section>

  <section id="info">
    <h2>Tour Information</h2>
  <p>Six Lakes Splendour is a calm, half-day journey through the very heart of the Lake District, linking six remarkable waters in one beautifully balanced route. We begin in Windermere, climbing gently to a viewpoint that opens the first grand sweep across the lake and its surrounding fells. It’s an inviting start, a moment to breathe in the scenery before the road winds north through rolling hills and stone-walled lanes towards Brothers Water, a small, mirror-still tarn cradled by steep slopes.  The route then carries us into the valley of Ullswater, where we pause in Glenridding. Here, there’s time to wander to the shoreline, explore the village, or sit with a coffee and watch the boats move quietly across the water. It’s a gentle thirty minutes to stretch your legs and take in the calm of one of the most graceful valleys in the Lakes.
       From there, we trace the road along Ullswater’s wooded western shore, passing cascades and deep green ravines before heading west towards Castlerigg Stone Circle. Set high on an open ridge, the circle offers a perfect twenty minute stop. Ancient stones, open skies, and a full ring of mountain silhouettes on the horizon.
         Our next pause is at Thirlmere, where the reflections of Helvellyn stretch across the reservoir. A short ten minute stop gives time to admire the scale of the landscape and the quiet of the forest around it before we continue south towards Grasmere.
           Grasmere is a highlight in itself – a place of poets, small shops, and famous gingerbread, all wrapped around a shining lake. With around thirty minutes here, there’s time to wander to the water’s edge or explore the village streets at an easy pace.
            The journey home takes us past Rydal Water and the gentle slopes of Loughrigg, before we round off in Ambleside for a final pause – a fitting close to a few well spent hours.
              Six Lakes Splendour isn’t a rushed guided tour. It’s sightseeing as it should be – steady, clear and comfortable. Every mile is chosen with care, every stop placed where the views are at their best. It’s a simple, thoughtful way to see the Lakes in their natural rhythm.</p>  
  </section>

  <section id="book">
    <h2>Reservation</h2>

    <div class="booking-wrap">
 <div class="calendar-container">
  <div class="calendar-header">
    <button id="prevMonth" class="nav-arrow">‹</button>
    <div id="monthYear" class="month-year"></div>
    <button id="nextMonth" class="nav-arrow">›</button>
  </div>
  <div class="calendar-grid">
   <div class="calendar-days">
     <div>S</div>
      <div>M</div>
       <div>T</div>
        <div>W</div>
         <div>T</div>
          <div>F</div>
           <div>S</div>
   </div>
   <div class="calendar-dates" id="calendarGrid"></div>
 </div>  
   <p class="calendar-subtitle">AMBER DATES MARK THE DAYS THIS TOUR IS IN OPERATION.</p>
 </div>

<div class="seat-wrap">
        <h3>Seating Arrangement</h3>
  <p class="seat-subtitle">YOU ARE WELCOME TO CHOOSE YOUR OWN SEAT.</p>
        <div class="seat-grid" id="seatGrid">
          <div class="seat empty"></div>
          <div class="seat empty"></div>
          <div class="seat" data-seat="R3R1"></div>
          <div class="seat" data-seat="R3R2"></div>

          <div class="seat" data-seat="R4L1"></div>
          <div class="seat empty"></div>
          <div class="seat" data-seat="R4R1"></div>
          <div class="seat" data-seat="R4R2"></div>

          <div class="seat" data-seat="R5L1"></div>
          <div class="seat empty"></div>
          <div class="seat" data-seat="R5R1"></div>
          <div class="seat" data-seat="R5R2"></div>

          <div class="seat" data-seat="B1"></div>
          <div class="seat" data-seat="B2"></div>
          <div class="seat" data-seat="B3"></div>
          <div class="seat" data-seat="B4"></div>
        </div>
   <p class="seat-subtitle">A SUPPLIMENT APPLIES TO SOLO USE OF DOUBLE SEATS.</p>
          </div>
            </div>
  </section>

  <section id="bookingform">
  <h2>Booking Form</h2>

  <form id="reservationForm" novalidate>
    <div class="form-group">
      <label for="leadPassenger">Lead Passenger <span>*</span></label>
      <input type="text" id="leadPassenger" name="leadPassenger" placeholder="Full Name" required>
    </div>

    <div class="form-group-inline">
      <div>
        <label for="passengers">Other Passengers <span>*</span></label>
        <select id="passengers" name="passengers" required>
          <option value="" disabled selected>Select total seats</option>
        
        </select>
<p id="passengerInfo" class="seat-subtitle" 
  style="margin-top:8px;color:var(--gold);text-align:left;">
</p>
        
      </div>
    </div>

    <div class="form-group">
      <label for="contactNumber">Contact Number</label>
      <input type="tel" id="contactNumber" name="contactNumber" placeholder="Optional">
    </div>

    <div class="form-group">
      <label for="contactEmail">Contact Email <span>*</span></label>
      <input type="email" id="contactEmail" name="contactEmail" placeholder="example@email.com" required>
    </div>

    <div class="form-group">
      <label for="comments">Comments</label>
      <textarea id="comments" name="comments" placeholder="Space for any comments (max 500 characters)" maxlength="500"></textarea>
    </div>

    <div class="summary">
      <p><strong>Tour:</strong> Six Lakes Splendour</p>
      <p><strong>Date:</strong> <span id="selectedDate">Not selected</span></p>
      <p><strong>Seats:</strong> <span id="selectedSeats">Pending</span></p>
      <p><strong>Total:</strong> <span id="totalCost">£0.00</span></p>
      <a href="#" id="submitLink">Submit Reservation</a>
    </div>
  </form>
  </section>

  <footer>
    © <span id="year"></span> Tour The Lakes — Designed by 
    <a href="https://www.neonforge.co.uk" target="_blank">Neon Forge</a>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
  
    <!-- Firebase SDKs -->
<script type="module">
/* ===========================
   FIREBASE (Modular SDK)
=========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getDatabase, ref, child, get, runTransaction, push
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* Your config */
const firebaseConfig = {
  apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
  authDomain: "tourthelakes-1e165.firebaseapp.com",
  databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
  projectId: "tourthelakes-1e165",
  storageBucket: "tourthelakes-1e165.firebasestorage.app",
  messagingSenderId: "470758171431",
  appId: "1:470758171431:web:f06dd39b0f15b63b2bff02"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ===========================
   DOM HOOKS
=========================== */
const calendarGrid   = document.getElementById("calendarGrid");
const monthYearEl    = document.getElementById("monthYear");
const prevBtn        = document.getElementById("prevMonth");
const nextBtn        = document.getElementById("nextMonth");
const seatGrid       = document.getElementById("seatGrid");
const selectedDateEl = document.getElementById("selectedDate");
const selectedSeatsEl= document.getElementById("selectedSeats");
const passengersSel  = document.getElementById("passengers");
const passengerInfo  = document.getElementById("passengerInfo");
const totalCostEl    = document.getElementById("totalCost");
const submitLink     = document.getElementById("submitLink");
const leadPassenger  = document.getElementById("leadPassenger");
const contactEmail   = document.getElementById("contactEmail");
const commentsEl     = document.getElementById("comments");

/* ===========================
   STATE
=========================== */
let currentDateObj      = new Date();
let currentMonthAvail   = {};      // availability/sls (subset for the month)
let selectedDateKey     = null;    // "YYYY-MM-DD"
let dateData            = null;    // availability/sls/<date> payload
let basePriceNumber     = 0;       // numeric £
let outerSeatSet        = new Set(["R3R1","R4R1","R5R1","B2","B3"]);
const PAIRS = {
  R3R1:"R3R2", R3R2:"R3R1",
  R4R1:"R4R2", R4R2:"R4R1",
  R5R1:"R5R2", R5R2:"R5R1",
  B2:"B3",     B3:"B2"
};

/* Inject an Auto-allocate control under the seat grid (no HTML change needed) */
const autoWrap = document.createElement("div");
autoWrap.style.marginTop = "12px";
autoWrap.style.textAlign = "center";
  
  autoWrap.classList.add("auto-allocate");
  autoWrap.innerHTML = `
  <label style="cursor:pointer;user-select:none;">
    <input id="autoAllocateToggle" type="checkbox">
    AUTO ALLOCATE MY SEATS
  </label>
`;
  
seatGrid.parentElement.appendChild(autoWrap);
const autoToggle = document.getElementById("autoAllocateToggle");

/* ===========================
   UTILITIES
=========================== */
const monthNames = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

function parsePriceToNumber(v) {
  if (typeof v === "number") return v;
  if (!v) return 0;
  const n = parseFloat(String(v).replace(/[£,\s]/g,""));
  return isNaN(n) ? 0 : n;
}

function fmtGBP(n) {
  return `£${(n ?? 0).toFixed(2)}`;
}

function countActiveSeats(seats) {
  return Object.values(seats || {}).filter(s => s === "active").length;
}

function currentChosenSeats() {
  return Array.from(seatGrid.querySelectorAll(".seat.chosen"))
    .map(s => s.dataset.seat);
}

function setSelectedSeatsText(list) {
  selectedSeatsEl.textContent = (list && list.length) ? list.join(", ") : "Pending";
}

/* ===========================
   CALENDAR
=========================== */
async function renderCalendar(dateObj) {
  calendarGrid.innerHTML = "";
  const y = dateObj.getFullYear();
  const m = dateObj.getMonth(); // 0-based
  monthYearEl.textContent = `${monthNames[m]} ${y}`;

  // Pull availability root once for the month
  const rootSnap = await get(child(ref(db), "availability/sls"));
  const all = rootSnap.exists() ? rootSnap.val() : {};
  currentMonthAvail = {};
  const monthPrefix = `${y}-${String(m+1).padStart(2,"0")}`;

  for (const key of Object.keys(all)) {
    if (key.startsWith(monthPrefix)) currentMonthAvail[key] = all[key];
  }

  const firstDay = new Date(y, m, 1).getDay();
  const daysInMonth = new Date(y, m + 1, 0).getDate();

  // pad
  for (let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement("div"));

  for (let d=1; d<=daysInMonth; d++) {
    const iso = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const el = document.createElement("div");
    el.textContent = d;

    if (currentMonthAvail[iso]) {
      el.classList.add("active-date");
      el.addEventListener("click", () => handleDateClick(iso, el));
    } else {
      el.style.opacity = "0.25";
      el.style.cursor = "default";
    }
    calendarGrid.appendChild(el);
  }
}

function clearCalendarSelection() {
  document.querySelectorAll(".calendar-dates div").forEach(d => d.classList.remove("selected"));
}

async function handleDateClick(dateKey, cellEl) {
  clearCalendarSelection();
  cellEl?.classList.add("selected");
  selectedDateKey = dateKey;
  if (selectedDateEl) selectedDateEl.textContent = dateKey;

  // Load the date payload
  const snap = await get(child(ref(db), `availability/sls/${dateKey}`));
  if (!snap.exists()) {
    dateData = null;
    clearSeatGrid();
    totalCostEl.textContent = fmtGBP(0);
    return;
  }

  dateData = snap.val();
  basePriceNumber = parsePriceToNumber(dateData.price);

  // Update seats + passengers UI
  updateSeatGrid(dateData.seats || {});
  updatePassengersDropdown(dateData.capacity ?? 0, dateData.seats || {}, basePriceNumber);

  // Initial price refresh
  recalcTotal();
}

/* ===========================
   SEAT GRID BINDING
=========================== */
function updateSeatGrid(seatsData) {
  const seats = seatGrid.querySelectorAll(".seat");
  seats.forEach(seat => {
    const key = seat.dataset.seat;
    seat.classList.remove("booked","chosen","empty");
    seat.replaceWith(seat.cloneNode(true)); // remove stale listeners
  });

  // Requery after cloneNode replace
  Array.from(seatGrid.querySelectorAll(".seat")).forEach(seat => {
    const key = seat.dataset.seat;
    const state = (seatsData || {})[key];

    seat.classList.remove("booked","chosen","empty");
    seat.style.pointerEvents = "none";

    if (state === "booked") {
      seat.classList.add("booked");
    } else if (state === "active") {
      seat.style.pointerEvents = "auto";
      seat.addEventListener("click", onSeatClick);
    } else {
      seat.classList.add("empty");
    }
  });

  // If auto-allocate is on, (re)allocate to match passenger count
  if (autoToggle.checked) {
    autoAllocateToMatchPassengerCount();
  } else {
    // Keep summary consistent even if user manually toggled earlier
    setSelectedSeatsText(currentChosenSeats());
  }
}

function clearSeatGrid() {
  Array.from(seatGrid.querySelectorAll(".seat")).forEach(seat => {
    seat.classList.remove("booked","chosen");
    seat.classList.add("empty");
    seat.style.pointerEvents = "none";
  });
  setSelectedSeatsText([]);
}

function onSeatClick(e) {
  const seat = e.currentTarget;
  if (!dateData) return;
  const state = (dateData.seats || {})[seat.dataset.seat];
  if (state !== "active") return;

  seat.classList.toggle("chosen");

  const chosen = currentChosenSeats();
  setSelectedSeatsText(chosen);

  // If auto-allocate is on, turn it off (user is choosing manually)
  if (autoToggle.checked) autoToggle.checked = false;

  recalcTotal();
}

/* ===========================
   PASSENGERS DROPDOWN
=========================== */
function updatePassengersDropdown(capacity, seatsData, basePrice) {
  // available = min(capacity, active seats count)
  const activeCount = countActiveSeats(seatsData);
  const available = Math.max(0, Math.min(capacity ?? 0, activeCount));

  // rebuild options
  passengersSel.innerHTML = "";
  const ph = document.createElement("option");
  ph.disabled = true; ph.selected = true;
  ph.textContent = "Select total seats";
  passengersSel.appendChild(ph);

  for (let i=1; i<=available; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    passengersSel.appendChild(opt);
  }

  // helper text + events
  passengersSel.onchange = () => {
    const num = parseInt(passengersSel.value || "0", 10);
    if (passengerInfo) {
      passengerInfo.textContent =
        (num <= 1) ? "You only" :
        (num === 2) ? "You + 1 other" :
        `You + ${num-1} others`;
    }

    if (autoToggle.checked) {
      autoAllocateToMatchPassengerCount();
    }
    recalcTotal();
  };
}

/* ===========================
   PRICE: base × passengers + supplement
=========================== */
function calcSupplement(chosenList, seatsData) {
  // £20 if chosen is in outer set AND its pair is still "active" AND pair isn't also chosen
  let suppl = 0;
  for (const s of chosenList) {
    if (!outerSeatSet.has(s)) continue;
    const pair = PAIRS[s];
    if (!pair) continue;
    const pairState = (seatsData || {})[pair];
    const pairChosen = chosenList.includes(pair);

    if (pairState === "active" && !pairChosen) {
      suppl += 20;
    }
  }
  return suppl;
}

function recalcTotal() {
  if (!dateData) {
    totalCostEl.textContent = fmtGBP(0);
    return;
  }
  const pax = parseInt(passengersSel.value || "0", 10);
  const chosen = currentChosenSeats();

  // Base price part
  const base = basePriceNumber * (isNaN(pax) ? 0 : pax);

  // Supplement logic (only when we have chosen seats)
  let supplement = 0;
  if (chosen.length > 0) {
    supplement = calcSupplement(chosen, dateData.seats || {});
  }

  totalCostEl.textContent = fmtGBP(base + supplement);
}

/* ===========================
   AUTO-ALLOCATE
   - Prefer non-outer active seats
   - Fill up to selected passengers
=========================== */
function autoAllocateToMatchPassengerCount() {
  if (!dateData) return;
  const pax = parseInt(passengersSel.value || "0", 10);
  if (!pax || pax < 1) return;

  const seatsData = dateData.seats || {};
  // Clear any manual choices
  seatGrid.querySelectorAll(".seat.chosen").forEach(s => s.classList.remove("chosen"));

  // Build candidate lists
  const nonOuterActive = [];
  const outerActive    = [];
  Array.from(seatGrid.querySelectorAll(".seat")).forEach(s => {
    const key = s.dataset.seat;
    const state = seatsData[key];
    if (state === "active") {
      if (outerSeatSet.has(key)) outerActive.push(s);
      else nonOuterActive.push(s);
    }
  });

  // Prefer non-outer, then outer
  const ordered = [...nonOuterActive, ...outerActive];

  for (let i=0; i<pax && i<ordered.length; i++) {
    ordered[i].classList.add("chosen");
  }

  const chosen = currentChosenSeats();
  setSelectedSeatsText(chosen);
  recalcTotal();
}

autoToggle.addEventListener("change", () => {
  if (autoToggle.checked) {
    autoAllocateToMatchPassengerCount();
  }
});

/* ===========================
   SUBMISSION (Atomic Tx)
=========================== */
function simpleEmailValid(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v || ""); }

submitLink.addEventListener("click", async (e) => {
  e.preventDefault();
  if (!selectedDateKey || !dateData) {
    alert("Please choose an available date first.");
    return;
  }
  const name  = (leadPassenger.value || "").trim();
  const email = (contactEmail.value || "").trim();
  const pax   = parseInt(passengersSel.value || "0", 10);
  const chosen= currentChosenSeats();
  const notes = (commentsEl.value || "").trim();

  if (!name)           return alert("Please enter the lead passenger name.");
  if (!pax)            return alert("Please select the total number of seats.");
  if (!simpleEmailValid(email)) return alert("Please provide a valid email address.");

  // If user hasn't selected seats (or selected too few), auto allocate if toggle is on
  if (chosen.length !== pax) {
    if (autoToggle.checked) {
      autoAllocateToMatchPassengerCount();
    }
  }
  const finalChosen = currentChosenSeats();
  if (finalChosen.length !== pax) {
    return alert(`Please select ${pax} seat(s), or enable auto-allocate.`);
  }

  // Guard: disable link to avoid double submits
  submitLink.style.pointerEvents = "none";
  submitLink.style.opacity = "0.6";
  submitLink.textContent = "Submitting…";

  try {
    // One atomic transaction on the date node (seats + capacity)
    const dateRef = ref(db, `availability/sls/${selectedDateKey}`);
    const txResult = await runTransaction(dateRef, (current) => {
      if (!current || !current.seats) return; // abort
      const seats = current.seats;
      const cap   = typeof current.capacity === "number" ? current.capacity : parseInt(current.capacity || "0", 10);

      // check enough capacity
      if (!cap || cap < pax) {
        return; // abort
      }

      // Ensure all chosen seats are still "active"
      for (const s of finalChosen) {
        if (seats[s] !== "active") {
          return; // abort
        }
      }

      // All good -> mark chosen seats as booked
      const nextSeats = { ...seats };
      finalChosen.forEach(s => { nextSeats[s] = "booked"; });

      const next = {
        ...current,
        seats: nextSeats,
        capacity: cap - pax,
        lastUpdated: new Date().toISOString()
      };
      return next;
    }, { applyLocally: false });

    if (!txResult.committed) {
      throw new Error("Seat availability changed or insufficient capacity.");
    }

    // Compute final price again (server truth would be better in production)
    const chosenNow = finalChosen;
    const supplement = calcSupplement(chosenNow, txResult.snapshot.val().seats || {});
    const total = basePriceNumber * pax + supplement;

    // Push booking record (separate write)
    await push(ref(db, `bookings/sls/${selectedDateKey}`), {
      tour: "Six Lakes Splendour",
      date: selectedDateKey,
      leadPassenger: name,
      passengers: pax,
      chosenSeats: chosenNow,
      contact: { email },
      comments: notes,
      totalGBP: Number(total.toFixed(2)),
      createdAt: new Date().toISOString()
    });

    // Reflect UI
    alert("Booking confirmed! A confirmation has been recorded.");
    totalCostEl.textContent = fmtGBP(total);
    // Refresh local seat grid from the committed snapshot
    dateData = txResult.snapshot.val();
    updateSeatGrid(dateData.seats || {});
    updatePassengersDropdown(dateData.capacity ?? 0, dateData.seats || {}, basePriceNumber);

  } catch (err) {
    console.error(err);
    alert(err.message || "Sorry, there was a problem submitting your booking.");
  } finally {
    submitLink.style.pointerEvents = "auto";
    submitLink.style.opacity = "1";
    submitLink.textContent = "Submit Reservation";
  }
});

/* ===========================
   INIT
=========================== */
prevBtn.addEventListener("click", () => {
  currentDateObj.setMonth(currentDateObj.getMonth() - 1);
  renderCalendar(currentDateObj);
});
nextBtn.addEventListener("click", () => {
  currentDateObj.setMonth(currentDateObj.getMonth() + 1);
  renderCalendar(currentDateObj);
});

await renderCalendar(currentDateObj);

/* Optional: comments autosize */
(function autosizeComments(){
  if (!commentsEl) return;
  const resize = () => {
    commentsEl.style.height = "auto";
    commentsEl.style.height = Math.min(commentsEl.scrollHeight, 240) + "px";
  };
  commentsEl.addEventListener("input", resize);
  resize();
})();
</script>

  
</body>
</html>
