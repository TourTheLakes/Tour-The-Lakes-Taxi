<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tour The Lakes</title>
  <meta name="description" content="Guided tours and special events across the Lake District, with commentary, scenic stops and time to explore."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@600;800&display=swap" rel="stylesheet">
  <!-- Tiny inline favicon to stop 404s -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='8' fill='%231b3f66'/%3E%3Cpath d='M10 42c10-6 16-10 22-10s12 4 22 10' stroke='%23fff' stroke-width='6' fill='none'/%3E%3Ccircle cx='26' cy='24' r='5' fill='%230fa3b1'/%3E%3C/svg%3E">
  <meta property="og:title" content="Tour The Lakes">
  <meta property="og:description" content="Full-day guided tours and special events across the Lake District.">
  <meta property="og:type" content="website">
  <style>
    :root{
      --ink:#0f2f4f; --ink2:#1b3f66; --accent:#0fa3b1;
      --bg:#f3f5f7; --card:#fff; --muted:#6b7280; --danger:#b91c1c;
      --radius:18px; --shadow:0 20px 50px rgba(15,47,79,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:#1f2937;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1,h2,h3{font-family:Outfit,Inter,system-ui; letter-spacing:.2px}
    a{color:var(--ink2);text-decoration:none}

    /* Hero */
    header{position:relative; overflow:hidden; padding:68px 16px 40px; text-align:center; color:#fff}
    .hero-layer{
      position:absolute; inset:-20% -10% auto -10%; height:120%;
      background: radial-gradient(55% 60% at 60% 40%, #1b3f66 0%, #0f2f4f 60%, #0b2740 100%);
      filter:saturate(1.05);
    }
    .blob{position:absolute; border-radius:50%;
      background: radial-gradient(closest-side, rgba(15,163,177,.35), rgba(15,163,177,0));
      animation: float 12s ease-in-out infinite alternate}
    .blob.b1{width:40vw; height:40vw; top:-8vw; left:-10vw}
    .blob.b2{width:32vw; height:32vw; bottom:-6vw; right:-8vw; animation-duration:14s}
    @keyframes float{to{transform:translateY(-12px) translateX(8px) scale(1.03)}}
    .hero-inner{position:relative; z-index:2; max-width:980px; margin:0 auto}
    .stamp{
      display:inline-flex; align-items:center; justify-content:center;
      width:120px; height:120px; margin:0 auto 14px; border-radius:50%;
      box-shadow: inset 0 6px 18px rgba(0,0,0,.25), 0 10px 30px rgba(0,0,0,.25);
      background:
        radial-gradient(circle at 30% 30%, #1c4776, #173a61 60%),
        repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,.15) 0 2px, rgba(0,0,0,0) 2px 4px);
      border:6px solid rgba(255,255,255,.7);
    }
    .stamp span{font-family:Outfit; font-weight:800; font-size:15px; line-height:1; text-transform:uppercase; color:#fff; letter-spacing:.6px; text-align:center}
    header h1{margin:8px 0 6px; font-size:38px}
    header p{margin:0; color:#e5e7eb}

    nav{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;background:#152a44;padding:10px}
    nav a{color:#e5e7eb;padding:10px 14px;border-radius:10px;font-weight:600}
    nav a:hover{background:#0e223a}

    main{max-width:1100px;margin:22px auto;padding:0 14px}
    section{background:var(--card);border-radius:var(--radius);margin:18px 0;padding:20px;box-shadow:var(--shadow)}
    h2{margin:0 0 12px;padding-bottom:8px;border-bottom:3px solid #e8eef5;color:var(--ink)}

    /* Cards */
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:780px){.grid{grid-template-columns:1fr 1fr}}
    .event{border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;background:#fff;position:relative; transition:transform .15s ease, box-shadow .15s ease}
    .event:hover{transform:translateY(-2px); box-shadow:0 16px 40px rgba(15,47,79,.12)}
    .event .imgwrap{width:100%;aspect-ratio:16/9;background:#eef3f8}
    .event img{width:100%;height:100%;object-fit:cover;display:block}
    .pad{padding:14px}
    .event h3{margin:0 0 6px;color:var(--ink)}
    .meta{font-size:14px;color:var(--muted);margin:2px 0 10px}
    .event.closed{opacity:.62}
    .btn{display:inline-block;border:0;border-radius:12px;padding:10px 16px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn:hover{filter:brightness(.94)}
    .btn.secondary{background:#e5e7eb;color:#111827}
    .btn.danger{background:#b91c1c;color:#fff}
    .pill{display:inline-block;padding:4px 9px;border-radius:999px;font-size:12px;margin-left:6px}
    .pill.ok{background:#e6fffb;color:#064e4e}
    .pill.closed{background:#fff1e6;color:#9a3412}
    .muted{color:var(--muted)}

    /* Admin + footer */
    #adminPanel{display:none}
    .admin-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px}
    footer{color:#94a3b8;text-align:center;padding:28px 12px}
    footer .staff{font-size:0; opacity:.5}
    footer .staff a{font-size:12px; opacity:.6}
  </style>
</head>
<body>
  <!-- Floaty Hero -->
  <header>
    <div class="hero-layer"></div>
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="hero-inner">
      <div class="stamp"><span>Tour<br>The<br>Lakes</span></div>
      <h1>Guided days in the Lake District</h1>
      <p>Stories, stops, and scenery — without the parking stress</p>
    </div>
  </header>

  <nav>
    <a href="#about">About</a>
    <a href="#tours">Tours</a>
    <a href="#events">Events</a>
    <a href="#contact">Contact</a>
    <a href="#admin" style="display:none" id="adminNav">Admin</a>
  </nav>

  <main>
    <section id="about">
      <h2>About</h2>
      <p>Full day tours with commentary, scenic stops and time to explore. A tour runs only once 20 fully paid participants are confirmed before the cut off. No pay on the day.</p>
    </section>

    <section id="tours">
      <h2>Upcoming Tours</h2>
      <div id="toursList" class="grid"><p class="muted">Loading tours…</p></div>
    </section>

    <section id="events">
      <h2>Special Events</h2>
      <div id="eventsList" class="grid"><p class="muted">Loading events…</p></div>
    </section>

    <section id="contact">
      <h2>Contact</h2>
      <p>Email <a href="mailto:info@tourthelakes.com">info@tourthelakes.com</a> for questions or group bookings.</p>
    </section>

    <section id="admin">
      <h2>Admin</h2>
      <div id="authBox" class="admin-bar" style="display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <button id="signInBtn" class="btn">Sign in with Google</button>
          <button id="signOutBtn" class="btn secondary" style="display:none">Sign out</button>
        </div>
        <small id="authStatus" class="muted">Not signed in</small>
      </div>

      <div id="adminPanel">
        <div style="height:1px;background:#e5e7eb;margin:14px 0"></div>
        <form id="createForm">
          <input type="hidden" id="editingId" value="">
          <input type="hidden" id="editingCol" value="">
          <div class="row" style="display:grid;gap:10px;grid-template-columns:1fr">
            <div>
              <label for="type">Type</label>
              <select id="type" required>
                <option value="tours">Tour</option>
                <option value="events">Event</option>
              </select>
            </div>
            <div>
              <label for="title">Title</label>
              <input id="title" type="text" maxlength="120" required placeholder="Windermere and Ambleside Full Day"/>
            </div>
          </div>

          <div class="row" style="display:grid;gap:10px;grid-template-columns:1fr">
            <div>
              <label for="date">Event date</label>
              <input id="date" type="date" required/>
            </div>
            <div>
              <label for="cutoff">Payment cut off</label>
              <input id="cutoff" type="date" required/>
            </div>
          </div>

          <div class="row" style="display:grid;gap:10px;grid-template-columns:1fr">
            <div>
              <label for="price">Price per person (£)</label>
              <input id="price" type="number" min="0" step="1" required placeholder="130"/>
            </div>
            <div>
              <label for="paymentLink">SumUp payment link</label>
              <input id="paymentLink" type="url" required placeholder="https://me.sumup.com/pay/..."/>
            </div>
          </div>

          <div>
            <label for="image">Feature image (optional)</label>
            <input id="image" type="file" accept="image/*"/>
            <div class="progress" style="margin-top:8px;display:none" id="progWrap"><div id="progBar"></div></div>
          </div>

          <div style="margin-top:10px">
            <label for="description">Description</label>
            <textarea id="description" placeholder="Route, highlights, timings…" required style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;min-height:90px;background:#fff"></textarea>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" type="submit" id="saveBtn">Save</button>
            <button class="btn secondary" type="button" id="cancelEditBtn" style="display:none">Cancel edit</button>
          </div>
        </form>
        <p id="saveMsg" class="muted" style="margin-top:10px"></p>
      </div>
    </section>
  </main>

  <footer>
    © <span id="yr"></span> Tour The Lakes
    <span class="staff"> · <a href="#admin" id="staffLink" aria-label="Admin">•</a></span>
  </footer>
  <script>
    // Keyboard shortcut: Shift + A opens Admin
    document.addEventListener('keydown', e=>{
      if (e.shiftKey && (e.key==='A' || e.key==='a')) location.hash = '#admin';
    });
    document.getElementById('yr').textContent = new Date().getFullYear();
  </script>

  <!-- App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy, doc, updateDoc, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getStorage, ref, uploadBytesResumable, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Firebase config for tourthelakes-1e165
    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.firebasestorage.app",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
      measurementId: "G-W6JY1LZXTP"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // Admin allow-list
    const ALLOWED_ADMIN_EMAILS = ["info@tourthelakes.com"];

    // Elements
    const $ = (id)=>document.getElementById(id);
    const signInBtn = $("signInBtn");
    const signOutBtn = $("signOutBtn");
    const authStatus = $("authStatus");
    const adminPanel = $("adminPanel");
    const adminNav = $("adminNav");

    // Auth UI
    signInBtn.onclick = async ()=>{
      try{
        await signInWithPopup(auth, provider);
      }catch(err){
        console.error("Auth error:", err.code, err.message);
        if (
          err.code === 'auth/operation-not-supported-in-this-environment' ||
          err.code === 'auth/popup-blocked' ||
          err.code === 'auth/popup-closed-by-user'
        ){
          await signInWithRedirect(auth, provider);
        }else{
          alert('Sign in failed: ' + err.code);
        }
      }
    };
    signOutBtn.onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, user=>{
      if (!user){
        authStatus.textContent = "Not signed in";
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        adminPanel.style.display = "none";
        adminNav.style.display = "none";
        return;
      }
      authStatus.textContent = user.email;
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
      const allowed = ALLOWED_ADMIN_EMAILS.includes(user.email ?? "");
      adminPanel.style.display = allowed ? "block" : "none";
      adminNav.style.display = allowed ? "inline-block" : "none";
      if (!allowed) authStatus.textContent += " (not authorised)";
    });

    // Logic
    function isClosed(dateStr, cutoffStr){
      const now = new Date();
      const d = new Date(dateStr);
      const c = new Date(cutoffStr);
      return now > c || now > d;
    }
    const fmtUK = s => {
      if (!s) return "";
      const [y,m,d] = s.split("-");
      return `${d}/${m}/${y}`;
    };

    function card(colName, id, data, isAdmin){
      const closed = isClosed(data.date, data.cutoff);
      const div = document.createElement("div");
      div.className = "event" + (closed ? " closed" : "");
      const pill = closed ? `<span class="pill closed">Closed</span>` : `<span class="pill ok">Open</span>`;
      const img = data.imageUrl ? `<div class="imgwrap"><img src="${data.imageUrl}" alt=""></div>` : `<div class="imgwrap"></div>`;
      div.innerHTML = `
        ${img}
        ${isAdmin ? `
          <div class="admin-actions">
            <button class="btn secondary" data-edit>Edit</button>
            <button class="btn danger" data-del>Delete</button>
          </div>` : ``}
        <div class="pad">
          <h3>${data.title} ${pill}</h3>
          <div class="meta">
            <strong>Date:</strong> ${fmtUK(data.date)}
            &nbsp; • &nbsp; <strong>Cut off:</strong> ${fmtUK(data.cutoff)}
            &nbsp; • &nbsp; <strong>Price:</strong> £${Number(data.price).toFixed(0)}
          </div>
          <p>${data.description}</p>
          ${closed ? `<p class="muted"><em>This listing is now closed.</em></p>` :
            `<button class="btn" onclick="window.open('${data.paymentLink}','_blank')">Book now</button>`}
        </div>
      `;
      if (isAdmin){
        div.querySelector("[data-edit]").onclick = ()=>beginEdit(colName, id, data);
        div.querySelector("[data-del]").onclick = async ()=>{
          if (!confirm("Delete this item?")) return;
          try{ await deleteDoc(doc(db, colName, id)); refreshLists(); }
          catch(e){ alert("Delete failed"); console.error(e); }
        };
      }
      return div;
    }

    async function fetchAll(colName){
      const q = query(collection(db, colName), orderBy("date","asc"));
      const snap = await getDocs(q);
      const items = [];
      snap.forEach(d=> items.push({id:d.id, data:d.data()}));
      const open = items.filter(x=>!isClosed(x.data.date, x.data.cutoff));
      const closed = items.filter(x=>isClosed(x.data.date, x.data.cutoff));
      return [...open, ...closed];
    }

    async function renderList(colName, mountId){
      const mount = $(mountId);
      mount.innerHTML = `<p class="muted">Loading…</p>`;
      try{
        const items = await fetchAll(colName);
        mount.innerHTML = "";
        const isAdmin = auth.currentUser && ALLOWED_ADMIN_EMAILS.includes(auth.currentUser.email ?? "");
        if (items.length === 0){ mount.innerHTML = `<p class="muted">No ${colName} yet.</p>`; return; }
        items.forEach(({id,data})=> mount.appendChild(card(colName, id, data, isAdmin)));
      }catch(err){
        console.error(err);
        mount.innerHTML = `<p class="muted">Could not load ${colName}.</p>`;
      }
    }
    function refreshLists(){ renderList("tours","toursList"); renderList("events","eventsList"); }
    refreshLists();

    // Admin form create/update + upload
    const form = $("createForm");
    const saveMsg = $("saveMsg");
    const progWrap = $("progWrap");
    const progBar = $("progBar");
    const cancelEditBtn = $("cancelEditBtn");
    const editingIdEl = $("editingId");
    const editingColEl = $("editingCol");

    function formToPayload(){
      return {
        title: $("title").value.trim(),
        date: $("date").value,
        cutoff: $("cutoff").value,
        price: Number($("price").value),
        paymentLink: $("paymentLink").value.trim(),
        description: $("description").value.trim(),
        createdAt: serverTimestamp()
      };
    }

    async function uploadImageIfAny(colName){
      const file = $("image").files[0];
      if (!file) return null;
      if (file.size > 5 * 1024 * 1024) { alert("Image too large. Keep under 5MB."); throw new Error("large"); }
      const safeName = file.name.replace(/[^\w.\-]+/g,"_");
      const path = `images/${colName}/${Date.now()}_${safeName}`;
      const storageRef = ref(storage, path);
      progWrap.style.display = "block";
      const task = uploadBytesResumable(storageRef, file);
      await new Promise((resolve, reject)=>{
        task.on("state_changed", snap=>{
          const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
          progBar.style.width = `${pct}%`;
        }, reject, resolve);
      });
      const url = await getDownloadURL(storageRef);
      progBar.style.width = "100%";
      return url;
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      saveMsg.textContent = "";

      const user = auth.currentUser;
      const allowed = user && ALLOWED_ADMIN_EMAILS.includes(user.email ?? "");
      if (!allowed){ alert("Not authorised"); return; }

      const colName = editingColEl.value || $("type").value;
      const payload = formToPayload();
      if (!payload.title || !payload.date || !payload.cutoff || !payload.paymentLink){
        alert("Please fill all required fields");
        return;
      }

      try{
        const url = await uploadImageIfAny(colName);
        if (url) payload.imageUrl = url;

        const editingId = editingIdEl.value;
        if (editingId){
          await updateDoc(doc(db, colName, editingId), payload);
          saveMsg.textContent = "Updated.";
        }else{
          await addDoc(collection(db, colName), payload);
          saveMsg.textContent = "Saved.";
        }
        form.reset();
        progWrap.style.display = "none";
        progBar.style.width = "0";
        editingIdEl.value = "";
        editingColEl.value = "";
        $("saveBtn").textContent = "Save";
        cancelEditBtn.style.display = "none";
        refreshLists();
      }catch(err){
        console.error(err);
        saveMsg.textContent = "Save failed";
      }
    });

    function beginEdit(colName, id, data){
      editingIdEl.value = id;
      editingColEl.value = colName;
      $("type").value = colName;
      $("title").value = data.title ?? "";
      $("date").value = data.date ?? "";
      $("cutoff").value = data.cutoff ?? "";
      $("price").value = data.price ?? 0;
      $("paymentLink").value = data.paymentLink ?? "";
      $("description").value = data.description ?? "";
      $("saveBtn").textContent = "Update";
      cancelEditBtn.style.display = "inline-block";
      window.location.hash = "#admin";
    }
    cancelEditBtn.onclick = ()=>{
      form.reset();
      editingIdEl.value = "";
      editingColEl.value = "";
      $("saveBtn").textContent = "Save";
      cancelEditBtn.style.display = "none";
    };
  </script>
</body>
</html>
