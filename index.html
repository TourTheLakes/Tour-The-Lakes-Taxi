<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tour The Lakes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/TTLFAVIcon.png">

    <style>
        html, body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #2b2b2b;
            overflow-x: hidden;
        }

*, *::before, *::after { box-sizing: border-box; }

.site-header {
  width: 100%;
}

.header-inner {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.brand {
  color: rgba(255,255,255,0.92);
  font: 600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

img {
  width: 100%;
  display: block;
}

.hero-wrapper {
  position: relative;
  border-top: 2px solid #b86b2a;
  border-bottom: 2px solid #b86b2a;
}

.hero-wrapper::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  pointer-events: none;
  z-index: 1;
}

.hero-wrapper h1 {
  font-weight: 600;
  position: absolute;
  left: 0;
  width: 100%;
  text-align: center;
  margin: 0;
  color: #b86b2a;
  z-index: 2;
}

.hero-wrapper p {
  position: absolute;
  left: 0;
  width: 100%;
  text-align: center;
  margin: 0;
  color: rgba(255,255,255,0.92);
  z-index: 2;
}

.hero-wrapper h1 { top: 35%; }
.hero-wrapper p  { top: 52%; }
.hero-wrapper h1 { font-size: 58px; }
.hero-wrapper p  { font-size: 28px; }

.hero-gap {
    height: 64px;
    width: 100%;
}

.tour-image img {
    max-height: 200px;
    object-fit: cover;
    position: relative;
    z-index: 0;
}

.tour-image::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  pointer-events: none;
  z-index: 1;
  border-top: 2px solid #b86b2a;
  border-bottom: 2px solid #b86b2a;
}

.tour-image {
  position: relative;
}

.tour-image .tour-title {
  position: absolute;
  left: 0;
  width: 100%;
  top: 18%;
  text-align: center;
  margin: 0;
  color: #b86b2a;
  z-index: 2;
  font: 600 58px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.tour-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 40px 0 20px 0;
}

.tour-divider-line {
  flex: 1;
  height: 1px;
  background: #b86b2a;
}

.tour-read,
.tour-more {
  font-size: 14px;
  font-weight: 400;
  color: rgba(255,255,255,0.6);
  margin: 0 8px;
  letter-spacing: 0.5px;
}

.tour-toggle {
  background: #2b2b2b;
  border: 1px solid #b86b2a;
  border-radius: 50%;
  padding: 8px;
  margin: 0 12px;
  cursor: pointer;
}

.tour-toggle img {
  display: block;
  width: 20px;
  height: 20px;
  border-bottom: none;
}

.tour-details {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 20px 40px 20px;

  font-weight: 600;
  color: rgba(255,255,255,0.92);
}

.tour-description {
    white-space: pre-wrap;
}

.tsec {
  margin-bottom: 24px;
}

.tsec-h {
  color: #b86b2a;
  font-weight: 600;
  font-size: 20px;
  margin-bottom: 8px;
}

.tsec-b {
  color: rgba(255,255,255,0.92);
  line-height: 1.5;
}

.tit-item {
  margin-bottom: 18px;
}

.tit-title {
  color: #b86b2a;
  font-weight: 600;
  margin-bottom: 6px;
}

.tit-body {
  color: rgba(255,255,255,0.92);
  line-height: 1.5;
}

.ttl-morebtn{
  background: transparent;
  border: 1px solid #b86b2a;
  color: #b86b2a;
  padding: 4px 10px;
  border-radius: 999px;
  cursor: pointer;
  font: 500 13px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
        
.tour-row {
  position: absolute;
  left: 0;
  width: 100%;
  z-index: 2;
  padding: 0 16px; 
  top: 52%;
  box-sizing: border-box;
}

.tour-meta {
  display: block;      
  max-width: 900px;
  margin: 0 auto;
  text-align: center;
  color: rgba(255,255,255,0.92);
  font: 500 20px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

.tour-image { 
  overflow: hidden; 
}

.tour-price,
.tour-seats {
  display: none !important;
}

.tour-nextdate {
  display: block;
  white-space: normal;
}

.tour-meta span {
  white-space: normal;
  overflow-wrap: anywhere;
}

.site-footer {
  width: 100%;
  border-top: 2px solid #b86b2a;
}

.footer-inner {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.footer-text {
  color: rgba(255,255,255,0.6);
  font: 400 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

@media screen and (min-width: 1024px) {
  .hero-wrapper img {
    max-height: 600px;
    object-fit: cover;
  }

.hero-wrapper h1 { top: 35%; }
.hero-wrapper p { top: 48%; }

.tour-image img {
    max-height: 300px;
    object-fit: cover;
  }

  .tour-row { 
      top: 46%; 
  }

}

@media screen and (max-width: 600px) {

  .hero-wrapper h1 {
    top: 32%;
    font-size: 36px;
  }

  .hero-wrapper p {
    top: 50%;
    font-size: 18px;
  }

  .tour-image .tour-title {
      font-size: 36px;
  }

  .tour-row { 
      top: 40%; 
  }

  .tour-meta {
    font-size: 13px;
    line-height: 1.25;
  }

}
        
    </style>
</head>
 <body>

    <header class="site-header">
  <div class="header-inner">
    <div class="brand">Tour The Lakes</div>
  </div>
</header>

<div class="hero-wrapper">
  <img src="images/DSC_0092.JPG.jpg" alt="Tour The Lakes Image" class="hero-image">

  <h1>Discover the Lakes</h1>
   <p>Sightseeing with a difference</p>
    
</div>

     <div class="hero-gap"></div>

<section id="tours"></section>

<template id="tourTemplate">
  <article class="tour" data-tour-id="">
   <div class="tour-image">
    <div class="tour-title"></div>


      <div class="tour-row">
       <div class="tour-meta">
        <span class="tour-price"></span>
         <span class="tour-nextdate"></span>
          <span class="tour-seats"></span>
          </div>
           </div>
            </div>

    <div class="tour-divider">
      <div class="tour-divider-line"></div>

      <span class="tour-read">Read</span>
        
      <button class="tour-toggle" type="button" aria-expanded="false">
        <img src="images/TTLFAVIcon.png" alt="Expand tour">
      </button>

    <span class="tour-read">More</span>
        
      <div class="tour-divider-line"></div>
    </div>

    <div class="tour-details" hidden>
      <div class="tour-description"></div>

      <div class="tour-booking-area">
        <div class="tour-calendar"></div>
        <div class="tour-workspace"></div>
      </div>
    </div>
  </article>
</template>


<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-text">© Tour The Lakes</div>
  </div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
  authDomain: "tourthelakes-1e165.firebaseapp.com",
  databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
  projectId: "tourthelakes-1e165",
  storageBucket: "tourthelakes-1e165.firebasestorage.app",
  messagingSenderId: "470758171431",
  appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
  measurementId: "G-W6JY1LZXTP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const toursEl = document.getElementById("tours");
const tpl = document.getElementById("tourTemplate");

// Keep track of per-tour listeners so we can clean them up on re-render
const tourDatesUnsubs = new Map();

function cleanupTourDatesListeners() {
  for (const unsub of tourDatesUnsubs.values()) {
    try {
      if (typeof unsub === "function") {
        unsub(); // Firebase unsubscribe
      }
    } catch {}
  }
  tourDatesUnsubs.clear();
}

function clearTours() {
  cleanupTourDatesListeners();
  toursEl.innerHTML = "";
}

function parseSlotDateTime(dateKey, timeStr) {
  // dateKey: "YYYY-MM-DD", timeStr: "HH:MM"
  const [y, m, d] = dateKey.split("-").map(Number);
  const [hh, mm] = String(timeStr || "").split(":").map(Number);
  if (!y || !m || !d || Number.isNaN(hh) || Number.isNaN(mm)) return null;
  return new Date(y, m - 1, d, hh, mm, 0, 0);
}

function formatNextLabel(dt, timeStr) {
  const datePart = dt.toLocaleDateString(undefined, {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
  return `Next: ${datePart} ${timeStr}`;
}

function formatGBP(value) {
  const n = Number(value);
  if (!Number.isFinite(n)) return "";
  return `£${n.toFixed(2)}`;
}

function findNextUpcomingSlot(datesObj) {
  if (!datesObj || typeof datesObj !== "object") return null;

  const now = new Date();
  let best = null;

  for (const [dateKey, dateNode] of Object.entries(datesObj)) {
    const timesObj = dateNode?.times;
    if (!timesObj || typeof timesObj !== "object") continue;

    for (const [timeStr, slot] of Object.entries(timesObj)) {
      const dt = parseSlotDateTime(dateKey, timeStr);
      if (!dt) continue;

      if (dt.getTime() < now.getTime()) continue;

      if (!best || dt.getTime() < best.dt.getTime()) {
        best = {
          dateKey,
          timeStr,
          dt,
          capacity: slot?.capacity ?? null,
          price: slot?.price ?? null
        };
      }
    }
  }

  return best;
}

    
function applyCollapses(rootEl, limit = 100) {
  if (!rootEl) return;

  const targets = rootEl.querySelectorAll(".tit-body, .tsec-b");

  targets.forEach((el) => {
    if (el.dataset.collapsed === "1") return;

    const fullHTML = el.innerHTML.trim();

    el.dataset.collapsed = "1";
    el.innerHTML = "";

    const shortSpan = document.createElement("span");
    shortSpan.className = "ttl-short";
    shortSpan.textContent = shortText;

    const fullSpan = document.createElement("span");
    fullSpan.className = "ttl-full";
    fullSpan.innerHTML = fullHTML;
    fullSpan.hidden = true;

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "ttl-morebtn";
    btn.textContent = "Read more";
    btn.setAttribute("aria-expanded", "false");

    btn.addEventListener("click", () => {
      const expanded = btn.getAttribute("aria-expanded") === "true";
      btn.setAttribute("aria-expanded", String(!expanded));
      fullSpan.hidden = expanded;
      shortSpan.hidden = !expanded;
      btn.textContent = expanded ? "Read more" : "Read less";
    });

    el.appendChild(shortSpan);
    el.appendChild(fullSpan);
    el.appendChild(document.createTextNode(" "));
    el.appendChild(btn);
  });
}

function attachTourDatesListener(tourId, articleEl) {
  const priceEl = articleEl.querySelector(".tour-price");
  const nextEl = articleEl.querySelector(".tour-nextdate");
  const seatsEl = articleEl.querySelector(".tour-seats");

  // sensible defaults while loading
  if (priceEl) priceEl.textContent = "";
  if (nextEl) nextEl.textContent = "";
  if (seatsEl) seatsEl.textContent = "";

  const datesRef = ref(db, `tours/${tourId}/dates`);
  const unsub = onValue(datesRef, (snap) => {
    const datesObj = snap.val();
    const next = findNextUpcomingSlot(datesObj);

    if (!next) {
      if (priceEl) priceEl.textContent = "";
      if (nextEl) nextEl.textContent = "";
      if (seatsEl) seatsEl.textContent = "";
      return;
    }

const title = articleEl.querySelector(".tour-title")?.textContent?.trim() || "tour";

const priceText = formatGBP(next.price); // already "£xx.xx" or ""
const datePart = next.dt.toLocaleDateString(undefined, {
  day: "2-digit",
  month: "short",
  year: "numeric"
});

const capNum = Number(next.capacity);
const capText = Number.isFinite(capNum) ? `${capNum}` : "";

const sentence =
  `Our next available ${title} is on ${datePart} at ${next.timeStr}` +
  (capText ? ` and we currently have ${capText} places left` : "") +
  (priceText ? ` at the price of ${priceText}.` : ".") +
  ` Read More to find out and book.`;

if (nextEl) nextEl.textContent = sentence;
if (priceEl) priceEl.textContent = "";
if (seatsEl) seatsEl.textContent = "";
      
  });

  tourDatesUnsubs.set(tourId, unsub);
}

function renderTours(toursObj) {
  clearTours();

  if (!toursObj) return;

  for (const [tourId, tour] of Object.entries(toursObj)) {
    if (!tour || tour.isLive !== true) continue;

    const node = tpl.content.cloneNode(true);
    const article = node.querySelector(".tour");
    article.dataset.tourId = tourId;

    node.querySelector(".tour-title").textContent = tour.title || tourId;

   const desc = node.querySelector(".tour-description");

desc.innerHTML = tour.description || "";

if (!tour.description) {
  desc.style.display = "none";
} else {
}

    const imageWrap = node.querySelector(".tour-image");
    if (tour.imageUrl) {
      const img = document.createElement("img");
      img.src = tour.imageUrl;
      img.alt = tour.title || "Tour image";
      imageWrap.appendChild(img);
    }

    toursEl.appendChild(node);

    // IMPORTANT: attach dates listener AFTER the node is in the DOM
    const insertedArticle = toursEl.querySelector(`.tour[data-tour-id="${tourId}"]`);
    if (insertedArticle) {
      attachTourDatesListener(tourId, insertedArticle);
    }
  }
}

// Listen to /tours. If empty/null => nothing renders.
onValue(ref(db, "tours"), (snapshot) => {
  renderTours(snapshot.val());
});

// Toggle open/close (works for dynamically-rendered tours)
document.addEventListener("click", (e) => {
  const toggle = e.target.closest(".tour-toggle");
  if (!toggle) return;

  const tour = toggle.closest(".tour");
  const details = tour.querySelector(".tour-details");
  const desc = tour.querySelector(".tour-description");

  const isOpen = toggle.getAttribute("aria-expanded") === "true";

  toggle.setAttribute("aria-expanded", String(!isOpen));
  details.hidden = isOpen;

  if (desc) {
  }
});

void db;
</script>

</body>
</html>
