<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tour The Lakes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/TTLFAVIcon.png">

    <style>
        html, body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #2b2b2b;
            overflow-x: hidden;
        }

*, *::before, *::after { box-sizing: border-box; }

.site-header {
  width: 100%;
}

.header-inner {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.brand {
  color: rgba(255,255,255,0.92);
  font: 600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

img {
  width: 100%;
  display: block;
}

.hero-wrapper {
  position: relative;
  border-top: 2px solid #b86b2a;
  border-bottom: 2px solid #b86b2a;
}

.hero-wrapper::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  pointer-events: none;
  z-index: 1;
}

.hero-wrapper h1 {
  font-weight: 600;
  position: absolute;
  left: 0;
  width: 100%;
  text-align: center;
  margin: 0;
  color: #b86b2a;
  z-index: 2;
}

.hero-wrapper p {
  position: absolute;
  left: 0;
  width: 100%;
  text-align: center;
  margin: 0;
  color: rgba(255,255,255,0.92);
  z-index: 2;
}

.hero-wrapper h1 { top: 35%; }
.hero-wrapper p  { top: 52%; }
.hero-wrapper h1 { font-size: 58px; }
.hero-wrapper p  { font-size: 28px; }

.hero-gap {
    height: 64px;
    width: 100%;
}

.tour-image img {
    max-height: 200px;
    object-fit: cover;
    position: relative;
    z-index: 0;
}

.tour-image::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  pointer-events: none;
  z-index: 1;
  border-top: 2px solid #b86b2a;
  border-bottom: 2px solid #b86b2a;
}

.tour-image {
  position: relative;
}

.tour-image .tour-title {
  position: absolute;
  left: 0;
  width: 100%;
  top: 18%;
  text-align: center;
  margin: 0;
  color: #b86b2a;
  z-index: 2;
  font: 600 58px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.tour-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 40px 0 20px 0;
}

.tour-divider-line {
  flex: 1;
  height: 1px;
  background: #b86b2a;
}

.tour-read,
.tour-more {
  font-size: 14px;
  font-weight: 400;
  color: rgba(255,255,255,0.6);
  margin: 0 8px;
  letter-spacing: 0.5px;
}

.tour-toggle {
  background: #2b2b2b;
  border: 1px solid #b86b2a;
  border-radius: 50%;
  padding: 8px;
  margin: 0 12px;
  cursor: pointer;
}

.tour-toggle img {
  display: block;
  width: 20px;
  height: 20px;
  border-bottom: none;
}

.tour-details {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px 20px 40px 20px;

  font-weight: 600;
  color: rgba(255,255,255,0.92);
}

.tour-description {
    white-space: pre-wrap;
}

.tsec {
  margin-bottom: 24px;
}

.tsec-h {
  color: #b86b2a;
  font-weight: 600;
  font-size: 20px;
  margin-bottom: 8px;
}

.tsec-b {
  color: rgba(255,255,255,0.92);
  line-height: 1.5;
}

.tit-item {
  margin-bottom: 18px;
}

.tit-title {
  color: #b86b2a;
  font-weight: 600;
  margin-bottom: 6px;
}

.tit-body {
  color: rgba(255,255,255,0.92);
  line-height: 1.5;
}
        
.tour-row {
  position: absolute;
  left: 0;
  width: 100%;
  z-index: 2;
  padding: 0 16px; 
  top: 52%;
  box-sizing: border-box;
}

.tour-meta {
  display: block;      
  max-width: 900px;
  margin: 0 auto;
  text-align: center;
  color: rgba(255,255,255,0.92);
  font: 500 20px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

.tour-image { 
  overflow: hidden; 
}

/* ===== Public calendar (match admin look) ===== */

.tour-booking-area{
  max-width: 900px;
  margin: 0 auto 40px auto;
  padding: 0 20px;
}

.tour-calendar{
  margin-top: 18px;
  border: 1px solid #b86b2a;
  padding: 14px;
  background: #2b2b2b;
}

.cal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom: 14px;
}

.cal-nav{
  border: 1px solid #b86b2a;
  background: #2b2b2b;
  color: #b86b2a;
  padding: 8px 12px;
  cursor: pointer;
  font: 400 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.cal-month{
  color: rgba(255,255,255,0.92);
  font: 600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

.cal-weekdays{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  margin-bottom: 6px;
}

.cal-weekdays div{
  text-align:center;
  font-weight:600;
  padding: 8px 0;
  color: rgba(255,255,255,0.92);
}

.cal-grid{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  grid-template-rows: repeat(6, 1fr);
  gap: 0;
}

.cal-cell{
  border: 1px solid #444;
  min-height: 52px;
  display:flex;
  align-items:flex-start;
  justify-content:flex-end;
  padding: 6px;
  color: rgba(255,255,255,0.8);
  cursor:pointer;
  user-select:none;
}

.cal-cell.is-empty{
  opacity: 0.25;
  cursor: default;
}

.cal-cell.has-data{
  background: rgba(184,107,42,0.15);
}

.cal-cell:not(.is-empty):hover{
  background: rgba(255,255,255,0.05);
}

.cal-cell.selected{
  border: 2px solid #b86b2a;
}

/* ===== Slots list (selectable, same visual language) ===== */

.slots-msg{
  margin: 14px 0 10px 0;
  color: rgba(255,255,255,0.6);
  font: 400 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.slots-list{
  display:flex;
  flex-direction:column;
  gap: 10px;
}

.slot-btn{
  width: 100%;
  text-align:left;
  border: 1px solid #b86b2a;
  background: #2b2b2b;
  color: rgba(255,255,255,0.92);
  padding: 12px;
  cursor: pointer;
  font: 500 15px/1.25 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.slot-btn.has-data{
  background: rgba(184,107,42,0.15); /* SAME as calendar has-data */
}

.slot-btn.selected{
  border: 2px solid #b86b2a;        /* SAME as calendar selected */
}

.slot-btn:disabled{
  opacity: 0.35;
  cursor: not-allowed;
}

.tour-price,
.tour-seats {
  display: none !important;
}

.tour-nextdate {
  display: block;
  white-space: normal;
}

.tour-meta span {
  white-space: normal;
  overflow-wrap: anywhere;
}

.site-footer {
  width: 100%;
  border-top: 2px solid #b86b2a;
}

.footer-inner {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.footer-text {
  color: rgba(255,255,255,0.6);
  font: 400 14px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

@media screen and (min-width: 1024px) {
  .hero-wrapper img {
    max-height: 600px;
    object-fit: cover;
  }

.hero-wrapper h1 { top: 35%; }
.hero-wrapper p { top: 48%; }

.tour-image img {
    max-height: 300px;
    object-fit: cover;
  }

  .tour-row { 
      top: 46%; 
  }

}

@media screen and (max-width: 600px) {

  .hero-wrapper h1 {
    top: 32%;
    font-size: 36px;
  }

  .hero-wrapper p {
    top: 50%;
    font-size: 18px;
  }

  .tour-image .tour-title {
      font-size: 36px;
  }

  .tour-row { 
      top: 40%; 
  }

  .tour-meta {
    font-size: 13px;
    line-height: 1.25;
  }

}
        
    </style>
</head>
 <body>

    <header class="site-header">
  <div class="header-inner">
    <div class="brand">Tour The Lakes</div>
  </div>
</header>

<div class="hero-wrapper">
  <img src="images/DSC_0092.JPG.jpg" alt="Tour The Lakes Image" class="hero-image">

  <h1>Discover the Lakes</h1>
   <p>Sightseeing with a difference</p>
    
</div>

     <div class="hero-gap"></div>

<section id="tours"></section>

<template id="tourTemplate">
  <article class="tour" data-tour-id="">
   <div class="tour-image">
    <div class="tour-title"></div>


      <div class="tour-row">
       <div class="tour-meta">
        <span class="tour-price"></span>
         <span class="tour-nextdate"></span>
          <span class="tour-seats"></span>
          </div>
           </div>
            </div>

    <div class="tour-divider">
      <div class="tour-divider-line"></div>

      <span class="tour-read">Read</span>
        
      <button class="tour-toggle" type="button" aria-expanded="false">
        <img src="images/TTLFAVIcon.png" alt="Expand tour">
      </button>

    <span class="tour-read">More</span>
        
      <div class="tour-divider-line"></div>
    </div>

<div class="tour-details" hidden>
  <div class="tour-description"></div>

  <div class="tour-booking-area">
    <!-- Calendar (public) -->
    <div class="tour-calendar">
      <div class="cal-header">
        <button type="button" class="cal-nav cal-prev">◀</button>
        <div class="cal-month"></div>
        <button type="button" class="cal-nav cal-next">▶</button>
      </div>

      <div class="cal-weekdays">
        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
      </div>

      <div class="cal-grid"></div>
    </div>

    <!-- Times list (public) -->
    <div class="tour-workspace">
      <div class="slots-msg">Select a date.</div>
      <div class="slots-list"></div>
    </div>
  </div>
</div>

      
  </article>
</template>


<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-text">© Tour The Lakes</div>
  </div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
  authDomain: "tourthelakes-1e165.firebaseapp.com",
  databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
  projectId: "tourthelakes-1e165",
  storageBucket: "tourthelakes-1e165.firebasestorage.app",
  messagingSenderId: "470758171431",
  appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
  measurementId: "G-W6JY1LZXTP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const toursEl = document.getElementById("tours");
const tpl = document.getElementById("tourTemplate");

// Keep track of per-tour listeners so we can clean them up on re-render
const tourDatesUnsubs = new Map();

function cleanupTourDatesListeners() {
  for (const unsub of tourDatesUnsubs.values()) {
    try { unsub(); } catch {}
  }
  tourDatesUnsubs.clear();
}

function clearTours() {
  cleanupTourDatesListeners();

  // clean up public calendars (listeners + state) before wiping DOM
  for (const state of tourCalStates.values()) {
    try { detachTourCalendarListeners(state); } catch {}
  }
  tourCalStates.clear();

  toursEl.innerHTML = "";
}

function parseSlotDateTime(dateKey, timeStr) {
  // dateKey: "YYYY-MM-DD", timeStr: "HH:MM"
  const [y, m, d] = dateKey.split("-").map(Number);
  const [hh, mm] = String(timeStr || "").split(":").map(Number);
  if (!y || !m || !d || Number.isNaN(hh) || Number.isNaN(mm)) return null;
  return new Date(y, m - 1, d, hh, mm, 0, 0);
}

function formatNextLabel(dt, timeStr) {
  // Matches your screenshot expectation: "Next: 22 Feb 2026 14:30"
  const datePart = dt.toLocaleDateString(undefined, {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
  return `Next: ${datePart} ${timeStr}`;
}

function formatGBP(value) {
  const n = Number(value);
  if (!Number.isFinite(n)) return "";
  // Keep it simple and consistent
  return `£${n.toFixed(2)}`;
}

function findNextUpcomingSlot(datesObj) {
  // datesObj shape:
  // dates[YYYY-MM-DD].times[HH:MM] = { capacity, price, ... }
  if (!datesObj || typeof datesObj !== "object") return null;

  const now = new Date();
  let best = null;

  for (const [dateKey, dateNode] of Object.entries(datesObj)) {
    const timesObj = dateNode?.times;
    if (!timesObj || typeof timesObj !== "object") continue;

    for (const [timeStr, slot] of Object.entries(timesObj)) {
      const dt = parseSlotDateTime(dateKey, timeStr);
      if (!dt) continue;

      // Only future (or "now") slots
      if (dt.getTime() < now.getTime()) continue;

      if (!best || dt.getTime() < best.dt.getTime()) {
        best = {
          dateKey,
          timeStr,
          dt,
          capacity: slot?.capacity ?? null,
          price: slot?.price ?? null
        };
      }
    }
  }

  return best;
}

// ===== Public calendar per-tour state =====
const tourCalStates = new Map(); // tourId -> state object

function pad2(n){ return String(n).padStart(2, "0"); }
function toKeyYYYYMMDD(y, m0, d){ return `${y}-${pad2(m0+1)}-${pad2(d)}`; }
function monthLabel(y, m0){
  const dt = new Date(y, m0, 1);
  return dt.toLocaleString(undefined, { month: "long", year: "numeric" });
}
function firstDayIndexMonFirst(y, m0){
  const js = new Date(y, m0, 1).getDay(); // Sun=0..Sat=6
  return (js + 6) % 7; // Mon=0..Sun=6
}
function daysInMonth(y, m0){ return new Date(y, m0+1, 0).getDate(); }

function ensureCalendarGrid(gridEl){
  const CELL_COUNT = 42;
  if (gridEl.children.length === CELL_COUNT) return;

  gridEl.innerHTML = "";
  for (let i=0; i<CELL_COUNT; i++){
    const cell = document.createElement("div");
    cell.className = "cal-cell is-empty";
    cell.dataset.key = "";
    cell.textContent = "";
    gridEl.appendChild(cell);
  }
}

function renderCalendarUI(state){
  const { monthEl, gridEl } = state;
  ensureCalendarGrid(gridEl);

  monthEl.textContent = monthLabel(state.viewYear, state.viewMonth);

  const startIdx = firstDayIndexMonFirst(state.viewYear, state.viewMonth);
  const dim = daysInMonth(state.viewYear, state.viewMonth);

  for (let i=0; i<42; i++){
    const cell = gridEl.children[i];
    cell.className = "cal-cell is-empty";
    cell.dataset.key = "";
    cell.textContent = "";

    const dayNum = i - startIdx + 1;
    if (dayNum < 1 || dayNum > dim) continue;

    const key = toKeyYYYYMMDD(state.viewYear, state.viewMonth, dayNum);
    cell.dataset.key = key;
    cell.textContent = String(dayNum);
    cell.classList.remove("is-empty");

    if (state.savedDates.has(key)) cell.classList.add("has-data");
    if (state.selectedDateKey === key) cell.classList.add("selected");
  }
}

function clearSlots(state, msg){
  state.slotsListEl.innerHTML = "";
  state.slotsMsgEl.textContent = msg || "Select a date.";
  state.selectedTime = "";
}

function renderSlots(state, timesObj){
  state.slotsListEl.innerHTML = "";

  if (!timesObj || typeof timesObj !== "object"){
    state.slotsMsgEl.textContent = "No times available for this date.";
    return;
  }

  const times = Object.keys(timesObj).sort();
  if (!times.length){
    state.slotsMsgEl.textContent = "No times available for this date.";
    return;
  }

  state.slotsMsgEl.textContent = `Available times for ${state.selectedDateKey}:`;

  for (const time of times){
    const slot = timesObj[time] || {};
    const cap = Number(slot.capacity);
    const price = Number(slot.price);

    // capacity is already "remaining places" per your instruction
    const capText = Number.isFinite(cap) ? `${cap}` : "";
    const priceText = Number.isFinite(price) ? `£${price.toFixed(2)}` : "";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "slot-btn has-data";
    btn.dataset.time = time;

    btn.textContent =
      `${time} — ${capText ? capText + " places remaining" : "places unknown"}` +
      `${priceText ? " — " + priceText : ""}`;

    // If you ever store 0, disable it (still visible)
    if (Number.isFinite(cap) && cap <= 0) btn.disabled = true;

    if (state.selectedTime === time) btn.classList.add("selected");

    btn.addEventListener("click", () => {
      if (btn.disabled) return;

      // local selection only
      state.selectedTime = time;

      // clear other selections visually
      state.slotsListEl.querySelectorAll(".slot-btn.selected")
        .forEach(x => x.classList.remove("selected"));
      btn.classList.add("selected");
    });

    state.slotsListEl.appendChild(btn);
  }
}

function detachTourCalendarListeners(state){
  if (typeof state.unsubDates === "function"){
    try { state.unsubDates(); } catch {}
  }
  if (typeof state.unsubTimes === "function"){
    try { state.unsubTimes(); } catch {}
  }
  state.unsubDates = null;
  state.unsubTimes = null;
}

function attachDatesListener(state){
  detachTourCalendarListeners(state); // clears both; we reattach times when date is clicked
  state.savedDates = new Set();

  const datesRef = ref(db, `tours/${state.tourId}/dates`);
  state.unsubDates = onValue(datesRef, (snap) => {
    const val = snap.val();
    state.savedDates = new Set();
    if (val && typeof val === "object"){
      for (const k of Object.keys(val)) state.savedDates.add(k);
    }
    renderCalendarUI(state);

    // if currently selected date disappears, clear slots
    if (state.selectedDateKey && !state.savedDates.has(state.selectedDateKey)){
      state.selectedDateKey = "";
      clearSlots(state, "Select a date.");
      renderCalendarUI(state);
    }
  });
}

function attachTimesListenerForDate(state){
  if (typeof state.unsubTimes === "function"){
    try { state.unsubTimes(); } catch {}
  }
  state.unsubTimes = null;

  if (!state.selectedDateKey){
    clearSlots(state, "Select a date.");
    return;
  }

  state.slotsMsgEl.textContent = "Loading times...";

  const timesRef = ref(db, `tours/${state.tourId}/dates/${state.selectedDateKey}/times`);
  state.unsubTimes = onValue(timesRef, (snap) => {
    renderSlots(state, snap.val());
  });
}

function initTourCalendar(tourId, articleEl){

  console.log(
    "initTourCalendar:",
    tourId,
    !!articleEl,
    !!articleEl?.querySelector(".tour-details"),
    !!articleEl?.querySelector(".tour-calendar"),
    !!articleEl?.querySelector(".cal-grid")
  );
    
  // only init once per tour
  if (tourCalStates.has(tourId)) return;

  const detailsEl = articleEl.querySelector(".tour-details");
  const calWrap = detailsEl.querySelector(".tour-calendar");
  const monthEl = calWrap.querySelector(".cal-month");
  const gridEl = calWrap.querySelector(".cal-grid");
  const prevBtn = calWrap.querySelector(".cal-prev");
  const nextBtn = calWrap.querySelector(".cal-next");

  const slotsMsgEl = detailsEl.querySelector(".slots-msg");
  const slotsListEl = detailsEl.querySelector(".slots-list");

  const now = new Date();
  const state = {
    tourId,
    articleEl,
    monthEl,
    gridEl,
    prevBtn,
    nextBtn,
    slotsMsgEl,
    slotsListEl,

    viewYear: now.getFullYear(),
    viewMonth: now.getMonth(),
    savedDates: new Set(),
    selectedDateKey: "",
    selectedTime: "",

    unsubDates: null,
    unsubTimes: null,
  };

  ensureCalendarGrid(gridEl);
  renderCalendarUI(state);
  clearSlots(state, "Select a date.");
  attachDatesListener(state);

  prevBtn.addEventListener("click", () => {
    state.viewMonth -= 1;
    if (state.viewMonth < 0){
      state.viewMonth = 11;
      state.viewYear -= 1;
    }
    renderCalendarUI(state);
  });

  nextBtn.addEventListener("click", () => {
    state.viewMonth += 1;
    if (state.viewMonth > 11){
      state.viewMonth = 0;
      state.viewYear += 1;
    }
    renderCalendarUI(state);
  });

  gridEl.addEventListener("click", (e) => {
    const cell = e.target.closest(".cal-cell");
    if (!cell) return;

    const key = cell.dataset.key;
    if (!key) return;

    state.selectedDateKey = key;
    state.selectedTime = ""; // selecting a new date clears time selection

    // visual selection
    gridEl.querySelectorAll(".cal-cell.selected")
      .forEach(c => c.classList.remove("selected"));
    cell.classList.add("selected");

    attachTimesListenerForDate(state);
  });

  tourCalStates.set(tourId, state);
}

function attachTourDatesListener(tourId, articleEl) {
  const priceEl = articleEl.querySelector(".tour-price");
  const nextEl = articleEl.querySelector(".tour-nextdate");
  const seatsEl = articleEl.querySelector(".tour-seats");

  // sensible defaults while loading
  if (priceEl) priceEl.textContent = "";
  if (nextEl) nextEl.textContent = "";
  if (seatsEl) seatsEl.textContent = "";

  const datesRef = ref(db, `tours/${tourId}/dates`);
  const unsub = onValue(datesRef, (snap) => {
    const datesObj = snap.val();
    const next = findNextUpcomingSlot(datesObj);

    if (!next) {
      if (priceEl) priceEl.textContent = "";
      if (nextEl) nextEl.textContent = "";
      if (seatsEl) seatsEl.textContent = "";
      return;
    }

const title = articleEl.querySelector(".tour-title")?.textContent?.trim() || "tour";

const priceText = formatGBP(next.price); // already "£xx.xx" or ""
const datePart = next.dt.toLocaleDateString(undefined, {
  day: "2-digit",
  month: "short",
  year: "numeric"
});

const capNum = Number(next.capacity);
const capText = Number.isFinite(capNum) ? `${capNum}` : "";

const sentence =
  `Our next available ${title} is on ${datePart} at ${next.timeStr}` +
  (capText ? ` and we currently have ${capText} places left` : "") +
  (priceText ? ` at the price of ${priceText}.` : ".") +
  ` Read More to find out and book.`;

if (nextEl) nextEl.textContent = sentence;
if (priceEl) priceEl.textContent = "";
if (seatsEl) seatsEl.textContent = "";
      
  });

  tourDatesUnsubs.set(tourId, unsub);
}

function renderTours(toursObj) {
  clearTours();

  if (!toursObj) return;

  for (const [tourId, tour] of Object.entries(toursObj)) {
    if (!tour || tour.isLive !== true) continue;

    const node = tpl.content.cloneNode(true);
    const article = node.querySelector(".tour");
    article.dataset.tourId = tourId;

    node.querySelector(".tour-title").textContent = tour.title || tourId;

    const desc = node.querySelector(".tour-description");
    desc.innerHTML = tour.description || "";
    if (!tour.description) desc.style.display = "none";

    const imageWrap = node.querySelector(".tour-image");
    if (tour.imageUrl) {
      const img = document.createElement("img");
      img.src = tour.imageUrl;
      img.alt = tour.title || "Tour image";
      imageWrap.appendChild(img);
    }

    toursEl.appendChild(node);

    // IMPORTANT: attach dates listener AFTER the node is in the DOM
    const insertedArticle = toursEl.querySelector(`.tour[data-tour-id="${tourId}"]`);
     if (insertedArticle) {
      attachTourDatesListener(tourId, insertedArticle);
       initTourCalendar(tourId, insertedArticle);
    }
  }
}

// Listen to /tours. If empty/null => nothing renders.
onValue(ref(db, "tours"), (snapshot) => {
  console.log("tours snapshot:", snapshot.val());
  renderTours(snapshot.val());
});

// Toggle open/close (works for dynamically-rendered tours)
document.addEventListener("click", (e) => {
  const toggle = e.target.closest(".tour-toggle");
  if (!toggle) return;

  const tour = toggle.closest(".tour");
  const details = tour.querySelector(".tour-details");

  const isOpen = toggle.getAttribute("aria-expanded") === "true";
  toggle.setAttribute("aria-expanded", String(!isOpen));
  details.hidden = isOpen;
});

void db;
</script>

</body>
</html>
