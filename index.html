<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tour The Lakes</title>
  <meta name="description" content="Guided tours and special events across the Lake District."/>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <style>
    :root{
      --ink:#0f2f4f;
      --ink2:#1b3f66;
      --accent:#0fa3b1;
      --bg:#f3f5f7;
      --card:#ffffff;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:#1f2937;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--ink2);text-decoration:none}
    header{background:linear-gradient(180deg,var(--ink) 0%, var(--ink2) 100%);color:#fff;padding:28px 16px 22px;text-align:center}
    header h1{margin:0;font-size:28px}
    header p{margin:6px 0 0;color:#e5e7eb}
    nav{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;background:#152a44;padding:8px}
    nav a{color:#e5e7eb;padding:10px 14px;border-radius:8px;font-weight:600}
    nav a:hover{background:#0e223a}
    main{max-width:980px;margin:22px auto;padding:0 12px}
    section{background:var(--card);border-radius:14px;margin:14px 0;padding:18px;box-shadow:0 6px 18px rgba(15,47,79,.08)}
    h2{margin:0 0 12px;padding-bottom:8px;border-bottom:3px solid #e8eef5;color:var(--ink)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .event{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
    .event .imgwrap{width:100%;aspect-ratio:16/9;background:#eef3f8;display:block}
    .event img{width:100%;height:100%;object-fit:cover;display:block}
    .pad{padding:12px}
    .event h3{margin:0 0 4px;color:#0f2f4f}
    .meta{font-size:14px;color:var(--muted);margin:4px 0 10px}
    .event.closed{opacity:.62}
    .btn{display:inline-block;border:0;border-radius:10px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn:hover{filter:brightness(.94)}
    .btn.secondary{background:#e5e7eb;color:#111827}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;margin-left:6px}
    .pill.ok{background:#e6fffb;color:#064e4e}
    .pill.closed{background:#fff1e6;color:#9a3412}
    .muted{color:var(--muted)}
    #adminPanel{display:none}
    .admin-bar{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:10px}
    .admin-bar small{color:var(--muted)}
    form .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:760px){form .row{grid-template-columns:1fr 1fr}}
    label{font-size:14px;font-weight:600;color:#374151}
    input, textarea, select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;background:#fff}
    textarea{min-height:90px}
    .hr{height:1px;background:#e5e7eb;margin:14px 0}
    .progress{height:8px;background:#e5e7eb;border-radius:6px;overflow:hidden}
    .progress > div{height:100%;width:0;background:var(--accent)}
    footer{color:#94a3b8;text-align:center;padding:28px 12px}
  </style>
</head>
<body>
  <header>
    <h1>Tour The Lakes</h1>
    <p>Guided tours and special events across the Lake District</p>
  </header>

  <nav>
    <a href="#about">About</a>
    <a href="#tours">Tours</a>
    <a href="#events">Events</a>
    <a href="#contact">Contact</a>
    <a href="#admin">Admin</a>
  </nav>

  <main>
    <section id="about">
      <h2>About</h2>
      <p>Full day tours with commentary, scenic stops and time to explore. A tour runs only once 20 fully paid participants are confirmed before the cut off. No pay on the day.</p>
    </section>

    <section id="tours">
      <h2>Upcoming Tours</h2>
      <div id="toursList" class="grid"><p class="muted">Loading tours…</p></div>
    </section>

    <section id="events">
      <h2>Special Events</h2>
      <div id="eventsList" class="grid"><p class="muted">Loading events…</p></div>
    </section>

    <section id="contact">
      <h2>Contact</h2>
      <p>Email <a href="mailto:info@tourthelakes.com">info@tourthelakes.com</a> for questions or group bookings.</p>
    </section>

    <section id="admin">
      <h2>Admin</h2>
      <div id="authBox" class="admin-bar">
        <div>
          <button id="signInBtn" class="btn">Sign in with Google</button>
          <button id="signOutBtn" class="btn secondary" style="display:none">Sign out</button>
        </div>
        <small id="authStatus">Not signed in</small>
      </div>

      <div id="adminPanel">
        <div class="hr"></div>
        <form id="createForm">
          <div class="row">
            <div>
              <label for="type">Type</label>
              <select id="type" required>
                <option value="tours">Tour</option>
                <option value="events">Event</option>
              </select>
            </div>
            <div>
              <label for="title">Title</label>
              <input id="title" type="text" maxlength="120" required placeholder="Windermere and Ambleside Full Day"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="date">Event date</label>
              <input id="date" type="date" required/>
            </div>
            <div>
              <label for="cutoff">Payment cut off</label>
              <input id="cutoff" type="date" required/>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="price">Price per person (£)</label>
              <input id="price" type="number" min="0" step="1" required placeholder="130"/>
            </div>
            <div>
              <label for="paymentLink">SumUp payment link</label>
              <input id="paymentLink" type="url" required placeholder="https://me.sumup.com/pay/..."/>
            </div>
          </div>

          <div>
            <label for="image">Feature image (optional)</label>
            <input id="image" type="file" accept="image/*"/>
            <div class="progress" style="margin-top:8px;display:none" id="progWrap"><div id="progBar"></div></div>
          </div>

          <div style="margin-top:10px">
            <label for="description">Description</label>
            <textarea id="description" placeholder="Route, highlights, timings…" required></textarea>
          </div>

          <div style="margin-top:12px">
            <button class="btn" type="submit">Save to Firebase</button>
          </div>
        </form>
        <p id="saveMsg" class="muted" style="margin-top:10px"></p>
      </div>
    </section>
  </main>

  <footer>© <span id="yr"></span> Tour The Lakes</footer>

  <!-- App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getStorage, ref, uploadBytesResumable, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Firebase config for tourthelakes-1e165
    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.firebasestorage.app",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
      measurementId: "G-W6JY1LZXTP"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    // Only allow this Google account to see Admin UI and write
    const ALLOWED_ADMIN_EMAILS = ["info@tourthelakes.com"];

    // Helpers
    const $ = (id)=>document.getElementById(id);
    $("yr").textContent = new Date().getFullYear();

    function isClosed(dateStr, cutoffStr){
      const now = new Date();
      const d = new Date(dateStr);
      const c = new Date(cutoffStr);
      return now > c || now > d;
    }

    function card(data){
      const closed = isClosed(data.date, data.cutoff);
      const div = document.createElement("div");
      div.className = "event" + (closed ? " closed" : "");
      const pill = closed ? `<span class="pill closed">Closed</span>` : `<span class="pill ok">Open</span>`;
      const img = data.imageUrl ? `<div class="imgwrap"><img src="${data.imageUrl}" alt=""></div>` : `<div class="imgwrap"></div>`;
      div.innerHTML = `
        ${img}
        <div class="pad">
          <h3>${data.title} ${pill}</h3>
          <div class="meta">
            <strong>Date:</strong> ${data.date}
            &nbsp; • &nbsp; <strong>Cut off:</strong> ${data.cutoff}
            &nbsp; • &nbsp; <strong>Price:</strong> £${Number(data.price).toFixed(0)}
          </div>
          <p>${data.description}</p>
          ${closed ? `<p class="muted"><em>This listing is now closed.</em></p>` :
            `<button class="btn" onclick="window.open('${data.paymentLink}','_blank')">Book now</button>`}
        </div>
      `;
      return div;
    }

    async function renderList(colName, mountId){
      const mount = $(mountId);
      mount.innerHTML = `<p class="muted">Loading…</p>`;
      try{
        const q = query(collection(db, colName), orderBy("date","asc"));
        const snap = await getDocs(q);
        mount.innerHTML = "";
        if (snap.empty){ mount.innerHTML = `<p class="muted">No ${colName} yet.</p>`; return; }
        snap.forEach(doc=> mount.appendChild(card(doc.data())));
      }catch(err){
        console.error(err); 
        mount.innerHTML = `<p class="muted">Could not load ${colName}.</p>`;
      }
    }

    renderList("tours","toursList");
    renderList("events","eventsList");

    // Auth UI
    const signInBtn = $("signInBtn");
    const signOutBtn = $("signOutBtn");
    const authStatus = $("authStatus");
    const adminPanel = $("adminPanel");

    signInBtn.onclick = async ()=>{
      try{
        await signInWithPopup(auth, provider);
      }catch(err){
        console.error("Auth error:", err.code, err.message);
        if (
          err.code === 'auth/operation-not-supported-in-this-environment' ||
          err.code === 'auth/popup-blocked' ||
          err.code === 'auth/popup-closed-by-user'
        ){
          await signInWithRedirect(auth, provider);
        }else{
          alert('Sign in failed: ' + err.code);
        }
      }
    };
    signOutBtn.onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, user=>{
      if (!user){
        authStatus.textContent = "Not signed in";
        signInBtn.style.display = "inline-block";
        signOutBtn.style.display = "none";
        adminPanel.style.display = "none";
        return;
      }
      authStatus.textContent = user.email;
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
      const allowed = ALLOWED_ADMIN_EMAILS.includes(user.email ?? "");
      adminPanel.style.display = allowed ? "block" : "none";
      if (!allowed) authStatus.textContent += " (not authorised)";
    });

    // Admin create with image upload
    const form = $("createForm");
    const saveMsg = $("saveMsg");
    const progWrap = $("progWrap");
    const progBar = $("progBar");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      saveMsg.textContent = "";

      const user = auth.currentUser;
      const allowed = user && ALLOWED_ADMIN_EMAILS.includes(user.email ?? "");
      if (!allowed){ alert("Not authorised"); return; }

      const file = $("image").files[0];
      const colName = $("type").value;

      const payload = {
        title: $("title").value.trim(),
        date: $("date").value,
        cutoff: $("cutoff").value,
        price: Number($("price").value),
        paymentLink: $("paymentLink").value.trim(),
        description: $("description").value.trim(),
        createdAt: serverTimestamp()
      };

      if (!payload.title || !payload.date || !payload.cutoff || !payload.paymentLink){
        alert("Please fill all required fields");
        return;
      }

      try{
        if (file){
          if (file.size > 5 * 1024 * 1024){ alert("Image too large. Keep under 5MB."); return; }
          const safeName = file.name.replace(/[^\w.\-]+/g,"_");
          const path = `images/${colName}/${Date.now()}_${safeName}`;
          const storageRef = ref(storage, path);
          progWrap.style.display = "block";
          const task = uploadBytesResumable(storageRef, file);
          await new Promise((resolve, reject)=>{
            task.on("state_changed", snap=>{
              const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
              progBar.style.width = `${pct}%`;
            }, reject, resolve);
          });
          const url = await getDownloadURL(storageRef);
          payload.imageUrl = url;
          progBar.style.width = "100%";
        }

        await addDoc(collection(db, colName), payload);
        saveMsg.textContent = "Saved. Lists refreshed.";
        form.reset();
        progWrap.style.display = "none";
        progBar.style.width = "0";
        renderList("tours","toursList");
        renderList("events","eventsList");
      }catch(err){
        console.error(err);
        saveMsg.textContent = "Save failed";
      }
    });
  </script>
</body>
</html>
