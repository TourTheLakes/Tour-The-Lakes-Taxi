<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon -->
  <link rel="icon" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" sizes="180x180">
  <link rel="mask-icon" href="https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/TTL-Favicon.png" color="#d8a04e">

  <title>Admin — Tour The Lakes</title>
  <meta name="description" content="Authorised administrator panel for Tour The Lakes.">
  <meta name="robots" content="noindex, nofollow">
  <meta name="theme-color" content="#0e1416">
  <meta name="color-scheme" content="dark light">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0e1416;
    --text: #e8e5df;
    --muted: #a5aaa9;
    --gold: #d8a04e;
    --tarn: #4b8ca7;
    --shadow: rgba(0, 0, 0, 0.5);
    --transition: 0.5s ease;
    --seat-size: 36px;
  }

  /* ========== GENERAL RESET / BASICS ========== */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; scroll-behavior: smooth; }
  body {
    font-family: "Work Sans", sans-serif;
    color: var(--text);
    background: var(--bg);
    overflow-x: hidden;
  }

  /* ========== HEADER ========== */
  header {
    position: fixed;
    top: 0; left: 0; width: 100%;
    background: rgba(14, 20, 22, 0.6);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    padding: 12px 60px;
    z-index: 100;
  }

  .brand {
    font-family: "Playfair Display", serif;
    font-size: 1.8rem;
    color: var(--gold);
    letter-spacing: 1px;
    text-decoration: none;
    transition: color var(--transition);
  }
  .brand:hover { color: var(--tarn); }

  nav a {
    margin-left: 28px;
    text-decoration: none;
    color: var(--muted);
    transition: color var(--transition);
  }
  nav a:hover { color: var(--gold); }

  .admin-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 28px;
    color: var(--muted);
    font-size: 1rem;
  }

  .admin-status a,
  .admin-status button {
    text-decoration: none;
    color: var(--muted);
    background: none;
    border: none;
    font-family: inherit;
    font-size: 1rem;
    cursor: pointer;
    transition: color var(--transition);
  }
  .admin-status a:hover,
  .admin-status button:hover { color: var(--gold); }

  /* ========== HERO ========== */
  .hero {
    min-height: 100vh;
    background: linear-gradient(rgba(14,14,14,0.4), rgba(14,14,14,0.8)),
      url('https://raw.githubusercontent.com/TourTheLakes/Tour-The-Lakes-Taxi/main/assets/images/DSC_0092.JPG') center/cover no-repeat;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text);
    padding: 0 20px;
  }

  .hero h1 {
    font-family: "Playfair Display", serif;
    font-size: clamp(2.8rem, 6vw, 5rem);
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--gold);
    text-shadow: 0 2px 20px var(--shadow);
    animation: fadeUp 1.5s ease forwards;
    margin-bottom: 24px;
  }

  .hero p {
    font-size: 1.2rem;
    margin-bottom: 24px;
    color: var(--muted);
    animation: fadeUp 2s ease forwards;
  }

  /* ========== SECTION HEADINGS ========== */
  section {
    padding: 40px 10vw;
    text-align: left;
  }

  section h2 {
    font-family: "Playfair Display", serif;
    font-size: 2.5rem;
    color: var(--gold);
    margin-bottom: 20px;
  }

  section p {
    max-width: 760px;
    line-height: 1.7;
    font-size: 1.1rem;
    color: var(--muted);
  }

  /* ========== AVAILABILITY SPLIT LAYOUT ========== */
  .availability-wrap {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 80px;
    flex-wrap: nowrap;
  }

  .calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    margin-top: 40px;
    text-align: left;
  }

  .control-room {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 20px;
    background: none;
    padding: 0;
    margin-top: 50px;
  }

  .control-room h3 {
    font-family: "Playfair Display", serif;
    font-weight: 500;
    color: var(--gold);
    font-size: 1.6rem;
    line-height: 1.2;
    text-align: center;
    margin: 0 auto 16px auto;
  }
  .control-room p { color: var(--muted); line-height: 1.5; }

  #dates h2 {
    text-align: center;
    width: 100%;
  }

/* ========== CALENDAR STYLES ========== */
  .calendar-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    margin-bottom: 24px;
    width: 540px;
    margin-left: auto;
    margin-right: auto;
  }

  .month-year {
    font-family: "Playfair Display", serif;
    font-size: 1.6rem;
    color: var(--gold);
    user-select: none;
    width: 190px;
    text-align: center;
  }

  .calendar-grid { width: 540px; }

  .calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    grid-auto-rows: 32px;
    text-align: center;
    font-size: 1rem;
    color: var(--gold);
    margin-bottom: 10px;
  }

  .calendar-dates {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 12px;
    grid-auto-rows: 32px;
    min-height: calc(6 * 32px + 5 * 12px);
    align-content: start;
    justify-items: center;
    font-size: 1rem;
    width: 540px;
  }

  .calendar-dates div {
    padding: 8px 0;
    font-size: 1rem;
    color: var(--text);
    user-select: none;
    text-align: center;
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  .calendar-dates div:hover {
    color: var(--gold);
    text-shadow: 0 0 10px rgba(216,160,78,0.3);
    cursor: pointer;
  }

  /* ===== Highlight for dates with stored data ===== */
.calendar-dates div.existing {
  background: linear-gradient(to bottom, var(--gold) 50%, var(--tarn) 50%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-fill-color: transparent;
  font-weight: 600; /* slight emphasis */
}

  /* ===== Calendar Arrows ===== */
  .nav-arrow {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--muted);
    cursor: pointer;
    transition: color var(--transition);
    user-select: none;
  }
.nav-arrow:hover { color: var(--gold); }


  /* ========== ADMIN TABS ========== */
  #admin-tabs {
    padding: 100px 10vw;
    text-align: left;
  }

  .tab-container {
    display: flex;
    justify-content: space-between;
    align-items: stretch;
    width: 100%;
    gap: 60px;
  }

  .tab {
    flex: 1;
    min-height: 380px;
  }
  
  .tab:nth-child(1),
  .tab:nth-child(2),
  .tab:nth-child(3) {
    text-align: center; }

  /* ========== TOUR SELECTOR LINKS (left tab) ========== */
  .tour-selector {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    margin-top: 50px;
  }
  .tour-link {
    font-family: "Playfair Display", serif;
    font-size: 1.6rem;
    font-weight: 500;
    color: var(--gold);
    text-decoration: none;
    letter-spacing: 0.5px;
    transition: opacity var(--transition), color var(--transition);
    text-align: center;
  }
  .tour-link:hover {
    color: var(--tarn);
    opacity: 0.85;
  }
  .tour-link.active {
    color: var(--tarn);
    text-shadow: 0 0 10px rgba(75,140,167,0.6);
  }

/* ===== AMEND FORM FINAL POLISH ===== */
#amendForm {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  text-align: center;
  margin-top: 40px;
  gap: 10px;
}

#amendFields {
  width: 100%;
  max-width: 380px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

#amendFields p {
  margin: 0;
  color: var(--text);
  font-family: "Work Sans", sans-serif;
  font-size: 1.05rem;
  line-height: 1.5;
  text-align: center;
}

#amendFields p strong {
  display: block;
  font-family: "Playfair Display", serif;
  font-weight: 600;
  font-size: 1.35rem;
  color: var(--gold);
  letter-spacing: 0.4px;
  margin-bottom: 2px;
  line-height: 1.2;
}

#amendForm label {
  display: block;
  font-family: "Playfair Display", serif;
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--gold);
  margin-top: 14px;
  margin-bottom: 4px;
  text-align: center;
  letter-spacing: 0.3px;
}

#amendForm input {
  width: 100%;
  max-width: 240px;
  text-align: center;
  background: none;
  border: none;
  border-bottom: 1px solid var(--gold);
  color: var(--text);
  font-family: "Work Sans", sans-serif;
  font-size: 1.05rem;
  padding: 4px 0 6px;
  outline: none;
  transition: border-color var(--transition);
}

#amendForm input:focus {
  border-color: var(--tarn);
}

#noDataMsg {
  font-family: "Playfair Display", serif;
  font-size: 1.4rem;
  color: var(--gold);
  font-weight: 500;
  text-align: center;
  letter-spacing: 0.4px;
  margin-top: 20px;
}

/* ========== SEATING GRID ========== */
.seat-grid {
  display: grid;
  grid-template-columns: repeat(4, var(--seat-size));
  grid-template-rows: repeat(4, var(--seat-size));
  gap: 18px;
  justify-content: center;
  align-content: center;
  margin-top: 30px;
}

.seat {
  position: relative;
  width: var(--seat-size);
  height: var(--seat-size);
  border-radius: 6px;
  background: #8b1a1a;
  box-shadow: inset 0 0 6px rgba(0,0,0,.4);
  transition: filter var(--transition), background var(--transition);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  user-select: none;
}

.seat::before {
  content: attr(data-seat);
  position: absolute;
  color: #fff;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.4px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.seat:hover { filter: brightness(1.15); }
.seat.booked { background: #155f1e; }
.seat.empty {
  background: #2a2f31;
  opacity: .7;
  pointer-events: none;
  cursor: default;
}

  .tab:nth-child(3) h3 {
    font-family: "Playfair Display", serif;
    font-size: 1.6rem;
    font-weight: 500;
    color: var(--gold);
    text-decoration: none;
    letter-spacing: 0.5px;
    transition: opacity var(--transition), color var(--transition);
    text-align: center;
  }

  /* ========== SAVE LINK INSIDE CONTROL ROOM ========== */
  .save-link {
    display: block;
    margin: 18px auto 0;
    font-size: 1.6rem;
    font-family: "Playfair Display", serif;
    text-decoration: none;
    color: var(--gold);
    cursor: pointer;
    transition: opacity var(--transition);
    text-align: center;
  }
  .save-link:hover { opacity: 0.7; }

  /* ========== FOOTER ========== */
  footer {
    background: #0b0f10;
    text-align: center;
    padding: 30px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 0.9rem;
    color: var(--muted);
  }
  footer a {
    color: var(--gold);
    text-decoration: none;
  }
  footer a:hover { text-decoration: underline; }

/* ========== RESPONSIVE BEHAVIOUR (Viewport-Fit, No Scrollbar) ========== */

/* Large tablets & small laptops */
@media (max-width: 900px) {
  header { padding: 12px 40px; }
  .brand { font-size: 1.5rem; }
  nav a { margin-left: 20px; font-size: 1rem; }

  .hero h1 { font-size: clamp(2.4rem, 5vw, 3.6rem); }
  .hero p { font-size: 1.05rem; padding: 0 24px; }

  section { padding: 80px 6vw; }

  .calendar-container,
  .control-room { align-items: center; }

  .calendar-grid,
  .calendar-days,
  .calendar-dates {
    width: 100%;
    max-width: 460px;
  }

  .month-year { font-size: 1.4rem; }

  #admin-tabs { padding: 80px 6vw; }
  .tab-container { gap: 40px; }
}

/* Tablets & phones */
@media (max-width: 700px) {
  html, body, section, #admin-tabs {
    overflow-x: hidden;
    width: 100%;
  }

  #userEmail {
    display: none;
  }

  header {
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 12px 0;
    text-align: center;
  }

  .brand {
    font-size: 1.4rem;
    line-height: 1.4;
    margin-bottom: 8px;
  }

  nav a {
    display: inline-block;
    margin: 0 10px;
    font-size: 0.95rem;
  }

  .hero h1 { font-size: clamp(2rem, 6vw, 3rem); }
  .hero p { font-size: 1rem; }

  section {
    padding: 60px 5vw;
  }

  .availability-wrap {
    flex-direction: column;
    gap: 40px;
    align-items: center;
  }

  .calendar-grid,
  .calendar-days,
  .calendar-dates {
    width: 100%;
    max-width: 340px;
    gap: 8px;
    grid-auto-rows: 28px;
    font-size: 0.85rem;
  }

  .month-year { font-size: 1.2rem; }
  .nav-arrow { font-size: 1.4rem; }

  #admin-tabs {
    padding: 60px 5vw;
  }

  .tab-container {
    flex-direction: column;
    align-items: center;
    gap: 50px;
  }

  .tab {
    text-align: center;
    border-bottom: 1px solid var(--gold);
    padding-bottom: 30px;
    width: 100%;
  }

  .tab:last-child { border-bottom: none; }

  .tour-link { font-size: 1.3rem; }
  #noDataMsg,
  #amendFields p strong,
  .tab:nth-child(3) h3 { font-size: 1.4rem; }

  footer {
    font-size: 0.8rem;
    padding: 20px;
  }
}

/* Small phones */
@media (max-width: 600px) {
  html, body {
    overflow-x: hidden;
    width: 100%;
  }

  .brand { font-size: 1.3rem; margin-bottom: 6px; }
  nav a { margin: 0 8px; font-size: 0.9rem; }

  .hero h1 { font-size: clamp(1.8rem, 6vw, 2.6rem); }
  .hero p { font-size: 0.95rem; }

  section { padding: 50px 4vw; }

  .calendar-grid,
  .calendar-days,
  .calendar-dates {
    width: 100%;
    max-width: 300px;
    gap: 6px;
    grid-auto-rows: 24px;
    font-size: 0.8rem;
  }

  .month-year { font-size: 1.1rem; }
  .nav-arrow { font-size: 1.2rem; }

  .tab-container { gap: 40px; }
  .tour-link { font-size: 1.2rem; }
  #noDataMsg,
  #amendFields p strong,
  .tab:nth-child(3) h3 { font-size: 1.3rem; }

  footer {
    font-size: 0.75rem;
    padding: 18px;
  }
}
</style>
  
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header>
    <a href="/" class="brand">Tour The Lakes</a>
    <nav class="admin-status">
      <span id="userEmail">You're logged on as ...</span>
      <a href="#dates" class="admin-link">Dates</a>
      <button id="logoutBtn" class="logout-btn" aria-label="Log out of admin panel">Log Off</button>
    </nav>
  </header>

  <!-- ===== HERO ===== -->
  <section class="hero">
    <h1>Admin Panel</h1>
    <p>Authorised access confirmed.</p>
  </section>

  <!-- ===== AVAILABILITY ===== -->
  <section id="dates">
    <h2>Availability</h2>
    <div class="availability-wrap" aria-labelledby="dates">
      <div class="calendar-container">
        <div class="calendar-header">
          <button id="prevMonth" class="nav-arrow" aria-label="Previous month">‹</button>
          <div id="monthYear" class="month-year"></div>
          <button id="nextMonth" class="nav-arrow" aria-label="Next month">›</button>
        </div>
        <div class="calendar-grid">
          <div class="calendar-days">
            <div>S</div><div>M</div><div>T</div><div>W</div>
            <div>T</div><div>F</div><div>S</div>
          </div>
          <div class="calendar-dates" id="calendarGrid"></div>
        </div>
      </div>

      <div class="control-room">
        <h3>Control Room</h3>
        <p id="selectedTourDisplay">No tour selected.</p>
        <p id="selectedDateDisplay">Select a date from the calendar to view details.</p>
        <div id="dateInfo"></div>
        <a href="#" id="saveChanges" class="save-link">Save Changes</a>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN TABS ===== -->
  <section id="admin-tabs">
    <div class="tab-container">

      <div class="tab">
        <div class="tour-selector">
          <a href="#" class="tour-link" data-tour="sls">Six Lakes Splendour</a>
          <a href="#" class="tour-link" data-tour="bp">Beatrix Potter</a>
          <a href="#" class="tour-link" data-tour="ws">Wordsworth’s Lakeland</a>
        </div>
      </div>

      <div class="tab">
        <form id="amendForm">
          <p id="noDataMsg">Select a tour and date to view or edit details.</p>
          <div id="amendFields" style="display:none;">
            <p><strong>Tour:</strong> <span id="formTour"></span></p>
            <p><strong>Date:</strong> <span id="formDate"></span></p>
            <label for="startTime">Tour Starting Time:</label>
            <input
              type="time"
               id="startTime"
                name="startTime"
                 placeholder="HH:MM"
                  pattern="[0-2][0-9]:[0-5][0-9]"
                   required
                    >
            <label for="price">Price (£):</label>
            <input type="text" id="price" name="price" placeholder="e.g. 65.00">
          </div>
        </form>
      </div>

      <div class="tab">
        <h3>Seating Arrangement</h3>
        <div class="seat-grid" id="seatGrid">
          <div class="seat empty"></div>
          <div class="seat empty"></div>
          <div class="seat" data-seat="R3R1"></div>
          <div class="seat" data-seat="R3R2"></div>

          <div class="seat" data-seat="R4L1"></div>
          <div class="seat empty"></div>
          <div class="seat" data-seat="R4R1"></div>
          <div class="seat" data-seat="R4R2"></div>

          <div class="seat" data-seat="R5L1"></div>
          <div class="seat empty"></div>
          <div class="seat" data-seat="R5R1"></div>
          <div class="seat" data-seat="R5R2"></div>

          <div class="seat" data-seat="B1"></div>
          <div class="seat" data-seat="B2"></div>
          <div class="seat" data-seat="B3"></div>
          <div class="seat" data-seat="B4"></div>
        </div>
      </div>

    </div>
  </section>

  <!-- ===== FOOTER ===== -->
  <footer>
    © <span id="year"></span> Tour The Lakes — Designed by
    <a href="https://www.neonforge.co.uk" target="_blank" rel="noopener noreferrer">Neon Forge</a>
  </footer>
</body>

 <!-- ===== FIREBASE + MAIN LOGIC ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ---------- Firebase Setup ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
  authDomain: "tourthelakes-1e165.firebaseapp.com",
  databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
  projectId: "tourthelakes-1e165",
  storageBucket: "tourthelakes-1e165.firebasestorage.app",
  messagingSenderId: "470758171431",
  appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
  measurementId: "G-W6JY1LZXTP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ---------- Auth Control ---------- */
const userEmail = document.getElementById("userEmail");
const logoutBtn = document.getElementById("logoutBtn");

onAuthStateChanged(auth, (user) => {
  if (user && user.email === "info@tourthelakes.com") {
    userEmail.textContent = `You're logged on as ${user.email}`;
  } else {
    window.location.href = "admin.html";
  }
});

logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  localStorage.clear();
  sessionStorage.clear();
  window.location.href = "admin.html";
});

document.getElementById("year").textContent = new Date().getFullYear();

/* ---------- LOCAL PAGE LOGIC (NO FIREBASE READS) ---------- */
const calendarGrid = document.getElementById("calendarGrid");
const monthYear = document.getElementById("monthYear");
const prevBtn = document.getElementById("prevMonth");
const nextBtn = document.getElementById("nextMonth");
const selectedDateDisplay = document.getElementById("selectedDateDisplay");
const dateInfo = document.getElementById("dateInfo");
const saveLink = document.getElementById("saveChanges");
const amendForm = document.getElementById("amendForm");
const amendFields = document.getElementById("amendFields");
const noDataMsg = document.getElementById("noDataMsg");
const formTour = document.getElementById("formTour");
const formDate = document.getElementById("formDate");
const seatGrid = document.getElementById("seatGrid");

let currentDate = new Date();
let activeTour = null;
let selectedDate = null;
let localSeatState = {};

/* ---------- Calendar ---------- */
function formatDate(y, m, d) {
  return `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
}

function renderCalendar(date) {
  calendarGrid.innerHTML = "";
  const year = date.getFullYear();
  const month = date.getMonth();
  const monthNames = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];
  monthYear.textContent = `${monthNames[month]} ${year}`;

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < firstDay; i++) calendarGrid.appendChild(document.createElement("div"));
  for (let d = 1; d <= daysInMonth; d++) {
    const div = document.createElement("div");
    const key = formatDate(year, month, d);
    div.textContent = d;
    div.addEventListener("click", () => handleDateClick(key, div));
    calendarGrid.appendChild(div);
  }
}

function handleDateClick(dateKey, element) {
  selectedDate = dateKey;
  document.querySelectorAll(".calendar-dates div").forEach(d => d.classList.remove("selected"));
  element.classList.add("selected");

  selectedDateDisplay.textContent = `Selected Date: ${dateKey}`;
  dateInfo.textContent = `Ready to assign or edit tour for ${dateKey}.`;

  if (!activeTour) {
    dateInfo.textContent = "Select a tour from Admin Tabs first.";
    return;
  }

  noDataMsg.style.display = "none";
  amendFields.style.display = "block";
  formTour.textContent = activeTour.toUpperCase();
  formDate.textContent = dateKey;
}

/* ---------- TOUR SELECTOR ---------- */
document.querySelectorAll(".tour-link").forEach(link => {
  link.addEventListener("click", e => {
    e.preventDefault();
    document.querySelectorAll(".tour-link").forEach(l => l.classList.remove("active"));
    link.classList.add("active");
    activeTour = link.dataset.tour;

    document.getElementById("selectedTourDisplay").textContent =
      `Selected Tour: ${link.textContent.trim()}`;
    selectedDateDisplay.textContent = "";
    dateInfo.textContent = "Select a date from the calendar to assign or edit.";

    noDataMsg.style.display = "block";
    amendFields.style.display = "none";
    formTour.textContent = "";
    formDate.textContent = "";
    document.getElementById("startTime").value = "";
    document.getElementById("price").value = "";
  });
});

/* ---------- SEATING LOGIC (LOCAL ONLY) ---------- */
seatGrid.querySelectorAll(".seat").forEach(seat => {
  seat.addEventListener("click", () => {
    if (!activeTour || !selectedDate) {
      alert("Select a tour and date first.");
      return;
    }
    if (seat.classList.contains("empty")) return;

    const seatKey = seat.dataset.seat;
    const isNowActive = !seat.classList.contains("booked");
    seat.classList.toggle("booked", isNowActive);

    if (!localSeatState[activeTour]) localSeatState[activeTour] = {};
    if (!localSeatState[activeTour][selectedDate]) localSeatState[activeTour][selectedDate] = {};
    localSeatState[activeTour][selectedDate][seatKey] = isNowActive ? "active" : "inactive";
  });
});

/* ---------- SAVE CHANGES (ONLY POINT OF FIREBASE CONTACT) ---------- */
saveLink.addEventListener("click", async (e) => {
  e.preventDefault();

  if (!activeTour) return alert("Please select a tour first.");
  if (!selectedDate) return alert("Please select a date first.");

  const startTime = document.getElementById("startTime").value.trim();
  const price = document.getElementById("price").value.trim();

  /* ---- ENFORCE FUTURE DATES ---- */
  const [y, m, d] = selectedDate.split("-").map(Number);
  const selectedDateObj = new Date(y, m - 1, d);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  if (selectedDateObj < today) {
    alert("You cannot assign tours to past dates.");
    return;
  }

  /* ---- ENFORCE 24-HOUR TIME FORMAT ---- */
  const timePattern = /^([01]\d|2[0-3]):([0-5]\d)$/;
  if (!timePattern.test(startTime)) {
    alert("Please enter a valid 24-hour time (HH:MM).");
    return;
  }

  /* ---- BLOCK PAST TIMES ON TODAY ---- */
  const now = new Date();
  if (selectedDateObj.toDateString() === now.toDateString()) {
    const [h, min] = startTime.split(":").map(Number);
    const check = new Date();
    check.setHours(h, min, 0, 0);
    if (check < now) {
      alert("Cannot assign a start time earlier than now.");
      return;
    }
  }

  /* ---- ENFORCE PRICE ---- */
  const numPrice = parseFloat(price.replace(/[£]/g, ""));
  if (isNaN(numPrice) || numPrice <= 0) {
    alert("Please enter a valid price (e.g. 12.00).");
    return;
  }
  const formattedPrice = `£${numPrice.toFixed(2)}`;

  /* ---- GATHER LOCAL SEAT DATA ---- */
  const seatData =
    localSeatState[activeTour]?.[selectedDate] || {};
  const activeSeats = Object.values(seatData).filter(s => s === "active").length;

  if (activeSeats === 0) {
    alert("You must activate at least one seat before saving.");
    return;
  }

  /* ---- FINAL PAYLOAD ---- */
  const payload = {
    tour: activeTour,
    date: selectedDate,
    startTime,
    price: formattedPrice,
    seats: seatData,
    capacity: activeSeats,
    lastUpdated: new Date().toISOString(),
  };

  /* ---- SINGLE FIREBASE WRITE ---- */
  try {
    await update(ref(db, `availability/${activeTour}/${selectedDate}`), payload);
    alert(`Saved ${activeTour.toUpperCase()} — ${selectedDate} ✅`);
  } catch (err) {
    console.error("Firebase write failed:", err);
    alert("An error occurred while saving. Please try again.");
  }
});

/* ---------- CALENDAR NAVIGATION ---------- */
prevBtn.addEventListener("click", () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar(currentDate);
});
nextBtn.addEventListener("click", () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar(currentDate);
});

/* ---------- INITIAL RENDER ---------- */
renderCalendar(currentDate);
</script> 

</html>
