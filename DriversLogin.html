<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Driver Login</title>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.appspot.com",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
      measurementId: "G-W6JY1LZXTP"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    async function driverLogin(event) {
      event.preventDefault();

      const enteredName = document.getElementById('driverName').value.trim();
      const enteredPassword = document.getElementById('driverPassword').value.trim();

      if (!enteredName || !enteredPassword) {
        alert('Please fill in both fields.');
        return;
      }

      const profileRef = ref(database, `driversProfile/${enteredName}`);
      
      try {
        const snapshot = await get(profileRef);

        if (snapshot.exists()) {
          const profileData = snapshot.val();
          if (profileData.password === enteredPassword) {
            // Create and save session token
            const sessionToken = Date.now();
            localStorage.setItem('driverName', profileData.name);
            localStorage.setItem('sessionToken', sessionToken);

            // Save session token to Firebase
            const sessionRef = ref(database, `driverSessions/${profileData.name}`);
            await set(sessionRef, {
              sessionToken: sessionToken
            }).catch((error) => {
              console.error('Failed to save session token:', error);
              alert('Login failed. Try again.');
              return; // Prevent redirect if session saving failed
            });

            // Redirect to Drivers.html
            window.location.href = 'Drivers.html';
          } else {
            alert('Incorrect password.');
          }
        } else {
          alert('Driver not found.');
        }
      } catch (error) {
        console.error(error);
        alert('Login failed.');
      }
    }

    window.driverLogin = driverLogin;
  </script>
</head>
<body>
  <h1>Driver Login</h1>
  <form onsubmit="driverLogin(event)">
    <label for="driverName">Driver Name:</label><br>
    <input type="text" id="driverName" name="driverName" required><br><br>

    <label for="driverPassword">Driver Password:</label><br>
    <input type="password" id="driverPassword" name="driverPassword" required><br><br>

    <button type="submit">Login</button>
  </form>
</body>
</html>
