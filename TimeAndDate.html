<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Choose Time and Date</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ&libraries=places"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0e0f10;
      --section-light: #1c1e21;
      --text-main: #f1f1f1;
      --text-sub: #aaaaaa;
      --accent: #4CAF50;
      --error: #cc0000;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }
    html, body {
      background-color: var(--bg-dark);
      background-image: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
      color: var(--text-main);
      height: 100%;
    }
    body { min-height: 100vh; display: flex; justify-content: center; padding: 40px 20px 60px; }
    .container {
      width: 100%;
      max-width: 600px;
      background: var(--section-light);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.3);
      animation: fadeIn 0.8s ease;
    }
    h1 { text-align: center; font-size: 28px; margin-bottom: 25px; font-weight: 600; }
    label { display: block; margin-top: 18px; margin-bottom: 6px; font-weight: 600; color: var(--text-main); }
    input[type="date"], select {
      width: 100%; padding: 12px; margin-bottom: 15px; border: none;
      border-radius: 12px; font-size: 15px; background: #2a2d31; color: var(--text-main);
    }
    .switch { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .switch input[type="checkbox"] { display: none; }
    .slider {
      width: 46px; height: 24px; background-color: #444;
      border-radius: 24px; position: relative; cursor: pointer; transition: background-color 0.3s;
    }
    .slider::before {
      content: ""; position: absolute; top: 2px; left: 2px;
      width: 20px; height: 20px; border-radius: 50%; background-color: white; transition: transform 0.3s;
    }
    input[type="checkbox"]:checked + .slider { background-color: var(--accent); }
    input[type="checkbox"]:checked + .slider::before { transform: translateX(22px); }
    #asapMessage, #inlineWarning {
      font-size: 14px; color: var(--text-sub); margin-top: 6px; display: none;
    }
    #inlineWarning { color: var(--error); }
    button {
      margin-top: 25px; padding: 14px; width: 100%;
      font-size: 16px; font-weight: 600; border: none;
      border-radius: 16px; background: #444; color: white; cursor: pointer;
    }
    button:hover { background-color: #222; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 480px) {
      body { padding: 20px; }
      .container { padding: 24px; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Choose Pickup Time</h1>

  <label class="switch">
    <input type="checkbox" id="asapCheckbox">
    <span class="slider"></span>
    <span>ASAP Pickup</span>
  </label>

  <p id="asapMessage">Average wait time is 15 minutes.</p>
  <p id="inlineWarning"></p>

  <div id="scheduleFields">
    <label for="pickupDate">Pickup Date:</label>
    <input type="date" id="pickupDate">

    <label for="pickupTime">Pickup Time:</label>
    <select id="pickupTime">
      <option value="">Select a time...</option>
    </select>
  </div>

  <button id="continueBtn">Continue</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
    authDomain: "tourthelakes-1e165.firebaseapp.com",
    databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
    projectId: "tourthelakes-1e165",
    storageBucket: "tourthelakes-1e165.appspot.com",
    messagingSenderId: "470758171431",
    appId: "1:470758171431:web:f06dd39b0f15b63b2bff02"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const pickupDate = document.getElementById("pickupDate");
  const pickupTime = document.getElementById("pickupTime");
  const asapCheckbox = document.getElementById("asapCheckbox");
  const asapMessage = document.getElementById("asapMessage");
  const inlineWarning = document.getElementById("inlineWarning");

  const today = new Date().toISOString().split("T")[0];
  pickupDate.setAttribute("min", today);
  pickupDate.value = today;

  async function populateTimes() {
    pickupTime.innerHTML = '<option value="">Select a time...</option>';

    const pickupCoords = JSON.parse(localStorage.getItem('pickupCoords'));
    const passengerCount = parseInt(localStorage.getItem('passengers') || 1);

    if (!pickupCoords) {
      inlineWarning.textContent = "Pickup location missing.";
      inlineWarning.style.display = "block";
      return;
    }

    const shiftsSnap = await db.ref("driverShifts").once("value");
    const statusSnap = await db.ref("driverStatus").once("value");
    const driversSnap = await db.ref("drivers").once("value");

    const shifts = shiftsSnap.val() || {};
    const statuses = statusSnap.val() || {};
    const drivers = driversSnap.val() || {};

    const pickupDateValue = pickupDate.value;
    const selectedDate = new Date(pickupDateValue);
    const isToday = pickupDateValue === today;

    const availableDrivers = [];

    for (const doorCard in statuses) {
      if (statuses[doorCard] !== "Available") continue;
      const shift = shifts[doorCard];
      const driver = drivers[doorCard];
      if (!shift || !driver) continue;
      if (parseInt(driver.vehicle.seats) < passengerCount) continue;

      const driverCoords = driver.coords;
      if (!driverCoords) continue;

      availableDrivers.push({ doorCard, driver, shift, driverCoords });
    }

    if (availableDrivers.length === 0) {
      inlineWarning.textContent = "No drivers are available for the selected date.";
      inlineWarning.style.display = "block";
      return;
    }

    inlineWarning.style.display = "none";

    const shiftStart = 7;
    const shiftEnd = 22;

    let startTime = new Date(selectedDate);
    startTime.setHours(shiftStart, 0, 0, 0);

    let endTime = new Date(selectedDate);
    endTime.setHours(shiftEnd, 0, 0, 0);

    const now = new Date();
    const minTime = new Date(now.getTime() + 30 * 60000);

    if (isToday && minTime > startTime) startTime = minTime;

    while (startTime <= endTime) {
      const h = startTime.getHours().toString().padStart(2, '0');
      const m = startTime.getMinutes().toString().padStart(2, '0');
      const optionTime = `${h}:${m}`;

      const matchingDriver = await findMatchingDriver(pickupCoords, availableDrivers, startTime);
      if (matchingDriver) {
        pickupTime.innerHTML += `<option value="${optionTime}">${optionTime}</option>`;
      }

      startTime.setMinutes(startTime.getMinutes() + 15);
    }
  }

  async function findMatchingDriver(pickupCoords, drivers, time) {
    const origins = [`${pickupCoords.lat},${pickupCoords.lng}`];
    const destinations = drivers.map(d => `${d.driverCoords.lat},${d.driverCoords.lng}`);
    const service = new google.maps.DistanceMatrixService();

    return new Promise((resolve) => {
      service.getDistanceMatrix(
        {
          origins,
          destinations,
          travelMode: 'DRIVING'
        },
        (response, status) => {
          if (status !== 'OK') return resolve(null);

          const elements = response.rows[0].elements;
          for (let i = 0; i < elements.length; i++) {
            const el = elements[i];
            if (el.status !== "OK") continue;

            const travelTimeMins = el.duration.value / 60;
            const driver = drivers[i];

            const [shiftFromHour] = driver.shift.from.split(':').map(Number);
            const [shiftUntilHour] = driver.shift.until.split(':').map(Number);
            const bookingHour = time.getHours();

            if (bookingHour >= shiftFromHour && bookingHour < shiftUntilHour && travelTimeMins <= 15) {
              return resolve(driver);
            }
          }
          resolve(null);
        }
      );
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    pickupDate.addEventListener("change", populateTimes);
    populateTimes();

    asapCheckbox.addEventListener("change", async function () {
      const isChecked = this.checked;
      if (isChecked) {
        const pickupCoords = JSON.parse(localStorage.getItem('pickupCoords'));
        const passengerCount = parseInt(localStorage.getItem('passengers') || 1);

        const shiftsSnap = await db.ref("driverShifts").once("value");
        const statusSnap = await db.ref("driverStatus").once("value");
        const driversSnap = await db.ref("drivers").once("value");

        const shifts = shiftsSnap.val() || {};
        const statuses = statusSnap.val() || {};
        const drivers = driversSnap.val() || {};

        const availableDrivers = [];

        for (const doorCard in statuses) {
          if (statuses[doorCard] !== "Available") continue;
          const shift = shifts[doorCard];
          const driver = drivers[doorCard];
          if (!shift || !driver) continue;
          if (parseInt(driver.vehicle.seats) < passengerCount) continue;

          const driverCoords = driver.coords;
          if (!driverCoords) continue;

          availableDrivers.push({ doorCard, driver, shift, driverCoords });
        }

        if (availableDrivers.length === 0) {
          inlineWarning.textContent = "No drivers are available for ASAP.";
          inlineWarning.style.display = "block";
          this.checked = false;
          return;
        }

        inlineWarning.style.display = "none";
        asapMessage.style.display = "block";
        pickupDate.disabled = true;
        pickupTime.disabled = true;
      } else {
        pickupDate.disabled = false;
        pickupTime.disabled = false;
        asapMessage.style.display = "none";
      }
    });

    document.getElementById("continueBtn").addEventListener("click", () => {
      const isASAP = asapCheckbox.checked;
      if (isASAP) {
        localStorage.setItem("pickupType", "ASAP");
        localStorage.removeItem("pickupDate");
        localStorage.removeItem("pickupTime");
      } else {
        const date = pickupDate.value;
        const time = pickupTime.value;

        if (!date || !time) {
          inlineWarning.textContent = "Please select both a date and time.";
          inlineWarning.style.display = "block";
          return;
        }

        localStorage.setItem("pickupType", "Scheduled");
        localStorage.setItem("pickupDate", date);
        localStorage.setItem("pickupTime", time);
      }

      location.href = "VerifyPhone.html";
    });
  });
</script>
</body>
</html>
