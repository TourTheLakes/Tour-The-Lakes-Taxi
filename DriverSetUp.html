<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Driver Set Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0e0f10;
      --section-light: #1c1e21;
      --text-main: #f1f1f1;
      --text-sub: #aaaaaa;
      --accent: #4CAF50;
      --accent-hover: #43a047;
      --button-text: #111;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Quicksand', sans-serif;
    }

    html, body {
      background-color: var(--bg-dark);
      background-image: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
      background-repeat: repeat;
      background-size: auto;
      color: var(--text-main);
      min-height: 100vh;
    }

    body {
      display: flex;
      justify-content: center;
      padding: 40px 20px;
    }

    .container {
      background: var(--section-light);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 500px;
      margin-top: 40px;
    }

    h2 {
      font-size: 26px;
      text-align: center;
      margin-bottom: 20px;
      color: var(--accent);
    }

    label {
      display: block;
      margin-top: 14px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 12px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      background: #2a2d31;
      color: var(--text-main);
    }

    button {
      margin-top: 20px;
      padding: 14px;
      width: 100%;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: var(--accent);
      color: var(--button-text);
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: var(--accent-hover);
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .button-row button {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Driver Set Up</h2>

    <select id="existingDriver" onchange="loadDriverDetails()">
      <option value="">-- Select Existing Driver --</option>
    </select>

    <input type="text" id="name" placeholder="Driver Name">
    <input type="text" id="doorCard" placeholder="Door Card Number e.g. S138">
    <input type="text" id="phone" placeholder="Phone Number (+44...)">
    <input type="text" id="make" placeholder="Vehicle Make">
    <input type="text" id="model" placeholder="Vehicle Model">
    <input type="text" id="color" placeholder="Vehicle Color">
    <input type="text" id="registration" placeholder="Registration">
    <input type="text" id="seats" placeholder="Seat Capacity">
    <input type="text" id="password" placeholder="Password">

    <div class="button-row">
      <button onclick="addUpdateDriver()">Add/Update Driver</button>
      <button onclick="deleteDriver()">Delete Driver</button>
      <button onclick="logoff()">Log Off</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.appspot.com",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    window.onload = function() {
      if (!localStorage.getItem("adminAccess")) {
        let pass = prompt("Enter admin password:");
        if (pass) {
          db.ref("adminPassword").once("value").then(snapshot => {
            if (snapshot.val() === pass) {
              localStorage.setItem("adminAccess", "true");
              loadDrivers();
              setTimeout(logoff, 10 * 60 * 1000); // 10 minutes timeout
            } else {
              alert("Wrong password. Access denied.");
              window.location.href = "index.html";
            }
          });
        } else {
          alert("Access denied.");
          window.location.href = "index.html";
        }
      } else {
        loadDrivers();
        setTimeout(logoff, 10 * 60 * 1000); // 10 minutes timeout
      }
    };

    function loadDrivers() {
      db.ref("drivers").once("value").then(snapshot => {
        const drivers = snapshot.val();
        const dropdown = document.getElementById("existingDriver");
        dropdown.innerHTML = '<option value="">-- Select Existing Driver --</option>';
        if (drivers) {
          Object.keys(drivers).forEach(key => {
            const driver = drivers[key];
            const option = document.createElement("option");
            option.value = key;
            option.textContent = driver.name + " (" + driver.doorCard + ")";
            dropdown.appendChild(option);
          });
        }
      });
    }

    function loadDriverDetails() {
      const key = document.getElementById("existingDriver").value;
      if (!key) return clearFields();

      db.ref("drivers/" + key).once("value").then(snapshot => {
        const driver = snapshot.val();
        if (driver) {
          document.getElementById("name").value = driver.name || "";
          document.getElementById("doorCard").value = driver.doorCard || "";
          document.getElementById("phone").value = driver.phone || "";
          document.getElementById("make").value = driver.vehicle?.make || "";
          document.getElementById("model").value = driver.vehicle?.model || "";
          document.getElementById("color").value = driver.vehicle?.color || "";
          document.getElementById("registration").value = driver.vehicle?.registration || "";
          document.getElementById("seats").value = driver.vehicle?.seats || "";
          document.getElementById("password").value = driver.password || "";
        }
      });
    }

    function addUpdateDriver() {
      const name = document.getElementById("name").value.trim();
      let doorCard = document.getElementById("doorCard").value.trim().toUpperCase();
      let phone = document.getElementById("phone").value.trim();
      const make = document.getElementById("make").value.trim();
      const model = document.getElementById("model").value.trim();
      const color = document.getElementById("color").value.trim();
      const registration = document.getElementById("registration").value.trim();
      const seats = document.getElementById("seats").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!name || !doorCard || !phone || !make || !model || !color || !registration || !seats || !password) {
        alert("All fields are mandatory.");
        return;
      }

      if (!/^S\d{3}$/.test(doorCard)) {
        alert("Door Card must start with 'S' followed by 3 digits (e.g. S138).");
        return;
      }

      if (phone.startsWith("0")) {
        phone = "+44" + phone.substring(1);
      } else if (!phone.startsWith("+44")) {
        alert("Phone number must start with +44 or 0.");
        return;
      }

      const newDriver = {
        name,
        doorCard,
        phone,
        vehicle: { make, model, color, registration, seats },
        password
      };

      const key = document.getElementById("existingDriver").value || db.ref("drivers").push().key;

      db.ref("drivers/" + key).set(newDriver).then(() => {
        alert("Driver saved successfully.");
        clearFields();
        loadDrivers();
      });
    }

    function deleteDriver() {
      const key = document.getElementById("existingDriver").value;
      if (!key) {
        alert("Select a driver to delete.");
        return;
      }

      if (confirm("Are you sure you want to delete this driver?")) {
        db.ref("drivers/" + key).remove().then(() => {
          alert("Driver deleted.");
          clearFields();
          loadDrivers();
        });
      }
    }

    function clearFields() {
      document.getElementById("name").value = "";
      document.getElementById("doorCard").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("make").value = "";
      document.getElementById("model").value = "";
      document.getElementById("color").value = "";
      document.getElementById("registration").value = "";
      document.getElementById("seats").value = "";
      document.getElementById("password").value = "";
      document.getElementById("existingDriver").selectedIndex = 0;
    }

    function logoff() {
      localStorage.removeItem("adminAccess");
      alert("You have been logged out.");
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
