<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tour The Lakes – Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/TTLFAVIcon.png">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #2b2b2b;
        }

.site-header {
  width: 100%;
  border-bottom: 1px solid #b86b2a;
}

.header-inner {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.brand {
  color: rgba(255,255,255,0.92);
  font: 600 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}

.admin-section-title {
  color: rgba(255,255,255,0.92);
  font: 600 18px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  text-align: center;
  margin-top: 30px;
  margin-bottom: 30px;
}



.site-footer {
  width: 100%;
  border-top: 1px solid #b86b2a;
}

.footer-inner {
  height: 64px;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.footer-text {
  color: rgba(255,255,255,0.6);
  font: 400 16px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  letter-spacing: 0.2px;
}
        
    </style>
</head>
<body>

    <header class="site-header">
  <div class="header-inner">
    <div class="brand">Tour The Lakes</div>
  </div>
</header>

<main style="padding:0 5%;">
  <div style="width:100%;">
      
    <div class="admin-section-title"> Create Tour </div>
    
    <div style="display:flex; flex-direction:column; gap:16px; width:100%;">
      <input id="tourTitle" type="text" style="width:100%; padding:12px; border:1px solid #b86b2a; background:#2b2b2b; color:rgba(255,255,255,0.92);">
      <input id="tourImageFile" type="file" accept="image/*" style="width:100%; padding:12px; border:1px solid #b86b2a; background:#2b2b2b; color:rgba(255,255,255,0.92);">
      <textarea id="tourDescription" rows="6" style="width:100%; padding:12px; border:1px solid #b86b2a; background:#2b2b2b; color:rgba(255,255,255,0.92); resize:vertical;"></textarea> 
        <label style="display:flex; gap:8px; align-items:center; color:rgba(255,255,255,0.92);">
            
        <input id="tourLive" type="checkbox"> Live </label>

       <button id="saveTour" type="button" style="width:100%; padding:12px; border:1px solid #b86b2a; background:#2b2b2b; color:#b86b2a; cursor:pointer;">
                 SAVE
                    </button>

      <div id="adminMsg" style="color:rgba(255,255,255,0.6); font:400 14px/1 system-ui;"></div>

<div style="margin-top:20px; color:rgba(255,255,255,0.92); font:600 16px/1 system-ui;">
  Existing Tours
</div>
    
<div id="tourList" style="margin-top:10px; display:flex; flex-direction:column; gap:12px; width:100%;"></div>

<div style="display:flex; gap:10px; margin-top:12px;">
  <button id="amendTour" type="button" style="padding:10px; border:1px solid #b86b2a; background:#2b2b2b; color:#b86b2a; cursor:pointer;">
    AMEND
  </button>
  <button id="deleteTour" type="button" style="padding:10px; border:1px solid #b86b2a; background:#2b2b2b; color:#b86b2a; cursor:pointer;">
    DELETE
  </button>
</div>
        
    </div>
  </div>
</main> 




<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-text">© Tour The Lakes</div>
  </div>
</footer>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
    authDomain: "tourthelakes-1e165.firebaseapp.com",
    databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
    projectId: "tourthelakes-1e165",
    storageBucket: "tourthelakes-1e165.firebasestorage.app",
    messagingSenderId: "470758171431",
    appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
    measurementId: "G-W6JY1LZXTP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  function slugifyTitle(input) {
  return String(input || "")
    .trim()
    .toLowerCase()
    .replace(/['"]/g, "")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");
}

const titleEl = document.getElementById("tourTitle");
const imgFileEl = document.getElementById("tourImageFile");
const liveEl = document.getElementById("tourLive");
const saveBtn = document.getElementById("saveTour");
const msgEl = document.getElementById("adminMsg");
const tourListEl = document.getElementById("tourList");
const amendBtn = document.getElementById("amendTour");
const deleteBtn = document.getElementById("deleteTour");
const descEl = document.getElementById("tourDescription");

function hardRefresh() {
  window.location.reload();
}

let selectedTourId = "";
let selectedTourData = null;

// Render list and allow selecting a tour
onValue(ref(db, "tours"), (snapshot) => {
  const tours = snapshot.val();
  tourListEl.innerHTML = "";

  if (!tours) return;

  for (const [tourId, tour] of Object.entries(tours)) {
    const row = document.createElement("button");
    row.type = "button";
    row.textContent = tour?.title ? tour.title : tourId;
    row.style.padding = "10px";
    row.style.border = "1px solid #b86b2a";
    row.style.background = (tourId === selectedTourId) ? "#1f1f1f" : "#2b2b2b";
    row.style.color = "rgba(255,255,255,0.92)";
    row.style.cursor = "pointer";
    row.style.textAlign = "left";

    row.addEventListener("click", () => {
      selectedTourId = tourId;
      selectedTourData = tour || null;

      // Load into the form for editing
      titleEl.value = tour?.title || "";
      liveEl.checked = !!tour?.isLive;
      descEl.value = tour?.description || "";

      msgEl.textContent = `Selected: ${tourId}`;
    });

    tourListEl.appendChild(row);
  }
});

amendBtn.addEventListener("click", async () => {
  if (!selectedTourId) {
    msgEl.textContent = "Select a tour first.";
    return;
  }

  const title = titleEl.value.trim();
  const isLive = !!liveEl.checked;
  const description = descEl.value.trim();

  if (!title) {
    msgEl.textContent = "Title required.";
    return;
  }

  try {
    // Keep existing imageUrl; only amend title/live in this step
    const imageUrl = selectedTourData?.imageUrl || "";

     await set(ref(db, `tours/${selectedTourId}`), {
     title,
     imageUrl,
     isLive,
     description
       });

    msgEl.textContent = `Amended: tours/${selectedTourId}`;
    hardRefresh();
  } catch (err) {
    msgEl.textContent = `Error: ${err?.message || err}`;
  }
});

deleteBtn.addEventListener("click", async () => {
  if (!selectedTourId) {
    msgEl.textContent = "Select a tour first.";
    return;
  }

  const ok = confirm(`Delete tour "${selectedTourId}" from database?`);
  if (!ok) return;

  try {
    await remove(ref(db, `tours/${selectedTourId}`));
    msgEl.textContent = `Deleted: tours/${selectedTourId}`;
    hardRefresh();

    selectedTourId = "";
    selectedTourData = null;
    titleEl.value = "";
    liveEl.checked = false;
  } catch (err) {
    msgEl.textContent = `Error: ${err?.message || err}`;
  }
});

saveBtn.addEventListener("click", async () => {

  if (selectedTourId) {
    msgEl.textContent = "Use AMEND to update an existing tour.";
    return;
  }

  const title = titleEl.value.trim();
  const isLive = !!liveEl.checked;
  const description = descEl.value.trim();

  if (!title) {
    msgEl.textContent = "Title required.";
    return;
  }

  const tourId = slugifyTitle(title);
  if (!tourId) {
    msgEl.textContent = "Invalid title.";
    return;
  }

  const file = imgFileEl.files && imgFileEl.files[0] ? imgFileEl.files[0] : null;

  let imageUrl = selectedTourData?.imageUrl || "";

  try {
    // If an image file is chosen, upload it first
    if (file) {
      const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
      const stamp = Date.now();
      const path = `tours/${tourId}/images/${stamp}-${safeName}`;

      const storageRef = sRef(storage, path);
      await uploadBytes(storageRef, file);
      imageUrl = await getDownloadURL(storageRef);
    }

     const tourData = {
      title,
      imageUrl,
      isLive,
      description
        };

    await set(ref(db, `tours/${tourId}`), tourData);
    msgEl.textContent = `Saved: tours/${tourId}`;
    hardRefresh();
  } catch (err) {
    msgEl.textContent = `Error: ${err?.message || err}`;
  }
});
    
  void db;
    
</script>

</body>
</html>
