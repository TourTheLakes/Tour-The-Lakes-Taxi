<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin – Tour The Lakes</title>

  <!-- Favicon = Admin Circle -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='58' fill='%2313161c' stroke='%23ffb84d' stroke-width='4'/%3E%3Ctext x='60' y='65' text-anchor='middle' fill='%23e8f1f8' font-family='Outfit' font-size='20' font-weight='800'%3EAdmin%3C/text%3E%3C/svg%3E"/>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0e1116; --ink:#e8f1f8; --muted:#a8b0bb;
      --neon:#55f0ff; --accent:#ffb84d;
      --line:#273341; --shadow:0 18px 40px rgba(0,0,0,.4);
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui;line-height:1.5}
    h1,h2{font-family:Outfit;margin:0 0 12px;text-align:center}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    .stamp{margin:40px auto 20px;width:160px;height:160px;border-radius:50%;
      background:#1a2633;border:4px solid var(--accent);
      display:flex;align-items:center;justify-content:center;
      font-family:Outfit;font-weight:800;font-size:22px;text-align:center;
      box-shadow:inset 0 12px 26px rgba(0,0,0,.45)}
    .logout{display:block;margin:12px auto 50px;padding:10px 18px;background:#1a1f27;color:var(--ink);
      border:1px solid var(--line);border-radius:8px;cursor:pointer}
    .panel{background:#151b22;padding:24px;border:1px solid #222c3a;border-radius:14px;margin-bottom:40px;box-shadow:var(--shadow)}
    form label{display:block;margin:14px 0 6px;font-weight:600}
    form input,form textarea,form select{width:100%;padding:12px;border-radius:8px;border:1px solid #2a3948;
      background:#0f141b;color:var(--ink);font-size:15px}
    .btn{margin-top:20px;padding:14px 18px;background:linear-gradient(90deg,var(--neon),#00d2ff);
      color:#00242a;font-weight:800;border:0;border-radius:10px;cursor:pointer;display:block}
    .list h2{text-align:left}
    table{width:100%;border-collapse:collapse;background:#0f141b;border-radius:10px;overflow:hidden}
    th,td{padding:12px 14px;border-bottom:1px solid #2a3948}
    th{background:#131a22;color:var(--neon);text-align:left}
    tr:hover td{background:#151d27}
    .export{text-align:right;margin-top:-20px;margin-bottom:20px}
    .export button{padding:10px 16px;border-radius:8px;border:1px solid #2a3948;background:#111820;color:var(--ink);cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stamp">Admin</div>
    <button id="logoutBtn" class="logout">Log out</button>

    <div class="panel">
      <h1>Create / Manage</h1>
      <!-- Create Tour/Event Form -->
      <form id="addForm">
        <label>Title <input name="title" required></label>
        <label>Description <textarea name="description" rows="4"></textarea></label>
        <label>Date <input type="date" name="date" required></label>
        <label>Cut off <input type="date" name="cutoff"></label>
        <label>Price (£) <input type="number" name="price"></label>
        <label>Capacity <input type="number" name="capacity" placeholder="optional"></label>
        <label>Min to run <input type="number" name="minNeeded" placeholder="default 20"></label>
        <label>Payment Info <textarea name="paymentInfo" rows="2"></textarea></label>
        <label>Image URL <input name="imageUrl" placeholder="https://..."></label>
        <label>Type
          <select name="type">
            <option value="tours">Tour</option>
            <option value="events">Event</option>
          </select>
        </label>
        <button class="btn">Add</button>
      </form>
    </div>

    <div class="panel">
      <div class="export">
        <button id="exportCSV">Export Interests CSV</button>
      </div>
      <h2>Current Listings</h2>
      <table id="listings">
        <thead><tr><th>Title</th><th>Date</th><th>Type</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.firebasestorage.app",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const addForm = document.getElementById("addForm");
    const logoutBtn = document.getElementById("logoutBtn");
    const listTable = document.querySelector("#listings tbody");

    onAuthStateChanged(auth, user=>{
      if(!user) window.location.href="index.html";
    });
    logoutBtn.addEventListener("click", ()=>signOut(auth));

    addForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd = new FormData(addForm);
      const type = fd.get("type");
      try{
        await addDoc(collection(db, type), {
          title: fd.get("title"),
          description: fd.get("description"),
          date: fd.get("date"),
          cutoff: fd.get("cutoff"),
          price: Number(fd.get("price")||0),
          capacity: Number(fd.get("capacity")||0),
          minNeeded: Number(fd.get("minNeeded")||20),
          paymentInfo: fd.get("paymentInfo"),
          imageUrl: fd.get("imageUrl"),
          createdAt: serverTimestamp()
        });
        addForm.reset();
        loadListings();
      }catch(err){console.error(err);}
    });

    async function loadListings(){
      listTable.innerHTML="";
      for(const col of ["tours","events"]){
        const snap = await getDocs(query(collection(db,col), orderBy("date","asc")));
        snap.forEach(doc=>{
          const d=doc.data();
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${d.title}</td><td>${d.date}</td><td>${col}</td><td>${d.cutoff && new Date(d.cutoff)<new Date()?"Closed":"Open"}</td>`;
          listTable.appendChild(tr);
        });
      }
    }
    loadListings();

    document.getElementById("exportCSV").addEventListener("click", async ()=>{
      let rows=[["Type","ListingID","Name","Email","Phone","Seats","Method","Created"]];
      for(const col of ["tours","events"]){
        const snap = await getDocs(collection(db,col));
        for(const doc of snap.docs){
          const subs = await getDocs(collection(db,col,doc.id,"interests"));
          subs.forEach(s=>{
            const x=s.data();
            rows.push([col,doc.id,x.name,x.email,x.phone,x.seats,x.method,x.createdAt?.toDate().toISOString()||""]);
          });
        }
      }
      let csv = rows.map(r=>r.map(v=>`"${(v||"").toString().replace(/"/g,'""')}"`).join(",")).join("\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download="interests.csv"; a.click();
    });
  </script>
</body>
</html>
