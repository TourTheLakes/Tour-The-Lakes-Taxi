<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Driver Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  <!-- === FIREBASE === -->  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>  <!-- === PDF EXPORT === -->  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>  <!-- === GOOGLE FONTS === -->  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />  <!-- === THEME STYLING === -->  <style>
    :root {
      --bg-dark: #0e0f10;
      --section-light: #1c1e21;
      --text-main: #f1f1f1;
      --accent: #4CAF50;
      --warn: #f44336;
      --logoff: #ff9800;
      --info: #2196F3;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Quicksand', sans-serif;
    }
    body {
      background-color: var(--bg-dark);
      color: var(--text-main);
      padding: 30px 15px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 900px;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 30px;
    }
    .greeting, .job, .log-entry {
      background: var(--section-light);
      border-left: 5px solid var(--info);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
    }
    .status-buttons button, .logoff-button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .logoff-button { background: var(--logoff); color: white; }
    .info { background: var(--info); color: white; }
    .accent { background: var(--accent); color: white; }
    .warn { background: var(--warn); color: white; }
    .hidden { display: none; }
  </style></head><body>
  <div class="container">
    <h1>Driver Dashboard</h1><div id="driverGreeting" class="greeting">
  <p id="driverGreetingText">Loading driver details...</p>
  <button class="logoff-button" onclick="logOffDriver()">Log Off</button>
</div>

<div id="bookingsContainer">
  <p>Loading bookings...</p>
</div>

<!-- === AUDIO CHIMES === -->
<audio id="chimeNew"><source src="https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg" type="audio/ogg"></audio>
<audio id="chimeCancel"><source src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" type="audio/ogg"></audio>
<audio id="chimeAmend"><source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg"></audio>

  </div><script>
// === FIREBASE INITIALISATION ===
const firebaseConfig = {
  apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
  authDomain: "tourthelakes-1e165.firebaseapp.com",
  databaseURL: "https://tourthelakes-1e165-default-rtdb.firebaseio.com",
  projectId: "tourthelakes-1e165",
  storageBucket: "tourthelakes-1e165.appspot.com",
  messagingSenderId: "470758171431",
  appId: "1:470758171431:web:f06dd39b0f15b63b2bff02"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === SESSION CHECK ===
const driverName = localStorage.getItem("driverName") || "";
const driverDoor = localStorage.getItem("driverDoor") || "";
const sessionExpires = localStorage.getItem("driverVerifiedUntil");

if (!driverName || !driverDoor || !sessionExpires || Date.now() > parseInt(sessionExpires)) {
  alert("Session expired or invalid. Please log in again.");
  localStorage.clear();
  window.location.href = "DriverLogin.html";
}

// === AUDIO UNLOCK ===
const chimeNew = document.getElementById("chimeNew");
const chimeCancel = document.getElementById("chimeCancel");
const chimeAmend = document.getElementById("chimeAmend");

document.addEventListener("click", () => {
  [chimeNew, chimeCancel, chimeAmend].forEach(audio => {
    audio.play().then(() => audio.pause()).catch(() => {});
  });
}, { once: true });

// === DRIVER GREETING ===
const greetingText = document.getElementById("driverGreetingText");
const bookingsContainer = document.getElementById("bookingsContainer");

// === REALTIME DRIVER TRACKING ===
function startDriverTracking() {
  if (!navigator.geolocation) return;

  function updateLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
      const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude, timestamp: Date.now() };
      db.ref("driverLocations/" + driverDoor).set(coords);
    }, err => {
      console.error("Geolocation error:", err);
    });
  }

  updateLocation();
  setInterval(updateLocation, 30000);
}
startDriverTracking();

// === LOAD DRIVER DETAILS ===
db.ref("drivers").once("value").then(snapshot => {
  const drivers = snapshot.val();
  for (const key in drivers) {
    const d = drivers[key];
    if (d.name?.toLowerCase() === driverName.toLowerCase() && String(d.doorCard) === driverDoor) {
      greetingText.innerHTML = `
        Hi <strong>${d.name}</strong>, you're in a
        <strong>${d.vehicle.make} ${d.vehicle.model}, ${d.vehicle.color}</strong> today
        that seats <strong>${d.vehicle.seats}</strong> passengers.
        Your door card number is <strong>${d.doorCard}</strong>,
        and the vehicle registration is <strong>${d.vehicle.registration}</strong>.
        Your customers can reach you on <strong>${d.phone}</strong>.
      `;
      break;
    }
  }
});

// === BOOKINGS DISPLAY ===
db.ref("bookings").on("value", snap => {
  const bookings = snap.val() || {};
  bookingsContainer.innerHTML = "";

  const myBookings = Object.entries(bookings).filter(([id, b]) =>
    b.claimedBy?.toLowerCase() === driverName.toLowerCase()
  );

  if (myBookings.length === 0) {
    bookingsContainer.innerHTML = `<p>No bookings currently assigned.</p>`;
    return;
  }

  myBookings.forEach(([id, b]) => {
    const when = b.pickupType === "ASAP" ? "ASAP" : `${b.pickupDate || "?"} at ${b.pickupTime || "?"}`;
    const div = document.createElement("div");
    div.className = "job";
    div.innerHTML = `
      <p><strong>Customer:</strong> ${b.name}</p>
      <p><strong>Phone:</strong> ${b.phone}</p>
      <p><strong>Pickup:</strong> ${b.pickup}</p>
      <p><strong>Drop-off:</strong> ${b.dropoff}</p>
      <p><strong>Time:</strong> ${when}</p>
      <p><strong>Passengers:</strong> ${b.passengers}</p>
      <p><strong>Luggage:</strong> ${b.luggage}</p>
      <p><strong>Pet:</strong> ${b.pets}</p>
      <p><strong>Notes:</strong> ${b.extra || "<em>None</em>"}</p>
      <div class="status-buttons">
        <button class="info" onclick="markStatus('${id}', 'On the Way')">On the Way</button>
        <button class="accent" onclick="markStatus('${id}', 'Arrived')">Arrived</button>
        <button class="warn" onclick="completeBooking('${id}')">Complete</button>
      </div>
    `;
    bookingsContainer.appendChild(div);
  });
});

// === MARK BOOKING STATUS ===
function markStatus(id, status) {
  db.ref("bookings/" + id + "/status").set(status).then(() => {
    alert(`Marked booking as '${status}'.`);
  });
}

// === COMPLETE BOOKING ===
function completeBooking(id) {
  const note = prompt("Driver notes (optional):", "");
  const finishedAt = new Date().toISOString();

  db.ref("bookings/" + id).once("value").then(snap => {
    const b = snap.val();
    if (!b) return;

    const completed = { ...b, driverComment: note || "", completedAt: finishedAt, completedBy: driverName };
    db.ref("completedJobs/" + id).set(completed).then(() => {
      db.ref("bookings/" + id).remove();
      alert("Booking completed and logged.");
      chimeNew.play();
    });
  });
}

// === LOG OFF ===
function logOffDriver() {
  if (confirm("You’re about to log off. Proceed?")) {
    db.ref("driverStatus/" + driverDoor).set("Logged Off").then(() => {
      localStorage.clear();
      window.location.href = "DriverLogin.html";
    });
  }
}

// === TIME STRING TO MINUTES ===
function timeToMinutes(t) {
  const [h, m] = t.split(":");
  return parseInt(h) * 60 + parseInt(m);
}

// === DIARY AVAILABILITY CHECK ===
function checkDiaryAvailability(driver, dateVal, timeVal) {
  return new Promise(resolve => {
    const doorCard = driver.doorCard;
    const bookingMinutes = timeToMinutes(timeVal);

    db.ref(`rota/${doorCard}/${dateVal}`).once("value").then(rotaSnap => {
      const shift = rotaSnap.val();
      if (!shift || !shift.start || !shift.end) return resolve(false);

      const shiftStart = timeToMinutes(shift.start);
      const shiftEnd = timeToMinutes(shift.end);
      if (bookingMinutes < shiftStart || bookingMinutes > shiftEnd) return resolve(false);

      db.ref(`breaks/${doorCard}/${dateVal}`).once("value").then(breakSnap => {
        const brk = breakSnap.val();
        if (brk && brk.from && brk.to) {
          const breakStart = timeToMinutes(brk.from);
          const breakEnd = timeToMinutes(brk.to);
          if (bookingMinutes >= breakStart && bookingMinutes <= breakEnd) return resolve(false);
        }

        db.ref("bookings").orderByChild("claimedDoor").equalTo(doorCard).once("value").then(bookingsSnap => {
          const bookings = bookingsSnap.val() || {};
          for (const id in bookings) {
            const b = bookings[id];
            if (b.pickupDate !== dateVal) continue;
            const jobMinutes = timeToMinutes(b.pickupTime);
            if (Math.abs(bookingMinutes - jobMinutes) < 30) return resolve(false);
          }
          resolve(true); // No conflicts found
        });
      });
    });
  });
}

// === FIND EARLIER AVAILABLE SLOT ===
function findEarlierAvailableSlot(driver, dateVal, timeVal) {
  return new Promise(async (resolve) => {
    const increment = 5;
    let attemptMinutes = timeToMinutes(timeVal);

    const shiftSnap = await db.ref(`rota/${driver.doorCard}/${dateVal}`).once("value");
    const shift = shiftSnap.val();
    if (!shift || !shift.start || !shift.end) return resolve(null);

    const shiftStart = timeToMinutes(shift.start);

    while (attemptMinutes > shiftStart) {
      attemptMinutes -= increment;
      const h = String(Math.floor(attemptMinutes / 60)).padStart(2, '0');
      const m = String(attemptMinutes % 60).padStart(2, '0');
      const attemptTime = `${h}:${m}`;
      const available = await checkDiaryAvailability(driver, dateVal, attemptTime);
      if (available) return resolve(attemptTime);
    }
    resolve(null);
  });
}

// === FIND NEXT AVAILABLE SLOT ===
function findNextAvailableSlot(driver, dateVal, timeVal) {
  return new Promise(async (resolve) => {
    const increment = 5;
    let attemptMinutes = timeToMinutes(timeVal);

    const shiftSnap = await db.ref(`rota/${driver.doorCard}/${dateVal}`).once("value");
    const shift = shiftSnap.val();
    if (!shift || !shift.start || !shift.end) return resolve(null);

    const shiftEnd = timeToMinutes(shift.end);

    if (attemptMinutes > shiftEnd) return resolve(null);

    while (attemptMinutes <= shiftEnd) {
      const h = String(Math.floor(attemptMinutes / 60)).padStart(2, '0');
      const m = String(attemptMinutes % 60).padStart(2, '0');
      const attemptTime = `${h}:${m}`;
      const available = await checkDiaryAvailability(driver, dateVal, attemptTime);
      if (available) return resolve(attemptTime);
      attemptMinutes += increment;
    }
    resolve(null);
  });
}

// === SUGGEST BEST AVAILABLE TIME (EARLIER THEN LATER) ===
function suggestBestAvailableTime(driver, dateVal, requestedTime) {
  findEarlierAvailableSlot(driver, dateVal, requestedTime).then(earlierTime => {
    if (earlierTime) {
      if (confirm(`No driver available exactly at your requested time.\n\nClosest earlier available slot is ${earlierTime}.\n\nDo you want to update your booking to this time?`)) {
        document.getElementById("bTime").value = earlierTime;
        updateEstimateDisplay();
        return;
      }
    }
    findNextAvailableSlot(driver, dateVal, requestedTime).then(nextTime => {
      if (nextTime) {
        if (confirm(`Closest later available slot is ${nextTime}.\n\nDo you want to update your booking to this time?`)) {
          document.getElementById("bTime").value = nextTime;
          updateEstimateDisplay();
        }
      } else {
        alert("No available time slots found today.");
      }
    });
  });
}

// === AUTO-ASSIGN DRIVER AFTER ESTIMATE ===
function autoAssignDriver() {
  if (!pickupCoords || !dropoffCoords) {
    assignedDriverField.value = "Awaiting address input...";
    return;
  }
  const dateVal = dateInput.value;
  const timeVal = timeInput.value;
  if (!dateVal || !timeVal) {
    assignedDriverField.value = "Awaiting date and time...";
    return;
  }

  db.ref("drivers").once("value").then(driverSnap => {
    const drivers = driverSnap.val() || {};
    const availableDrivers = [];

    const promises = Object.keys(drivers).map(driverKey => {
      const d = drivers[driverKey];
      return checkDiaryAvailability(d, dateVal, timeVal).then(isAvailable => {
        if (isAvailable) availableDrivers.push(d);
      });
    });

    Promise.all(promises).then(() => {
      if (availableDrivers.length > 0) {
        const selectedDriver = availableDrivers[0];
        assignedDriverField.value = `${selectedDriver.name} – ${selectedDriver.vehicle.make} ${selectedDriver.vehicle.model} – ${selectedDriver.vehicle.registration} – ${selectedDriver.vehicle.seats} Seats`;
      } else {
        assignedDriverField.value = "No driver available at requested time.";
        const anyDriver = Object.values(drivers)[0];
        if (anyDriver) {
          suggestBestAvailableTime(anyDriver, dateVal, timeVal);
        }
      }
    });
  });
}

// === LIVE DRIVER LOCATION TRACKING ===
function updateDriverLocation(position) {
  const coords = {
    lat: position.coords.latitude,
    lng: position.coords.longitude,
    timestamp: Date.now()
  };
  db.ref(`liveLocations/${driverDoor}`).set(coords);
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(updateDriverLocation);
  navigator.geolocation.watchPosition(updateDriverLocation, console.warn, {
    enableHighAccuracy: true,
    maximumAge: 10000,
    timeout: 10000
  });
} else {
  console.warn("Geolocation not supported.");
}

</script>

    
  </body>
</html>
