<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Master Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <!-- Google Maps Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ&libraries=places"></script>
  <!-- Fonts & Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-dark: #0e0f10;
      --section-light: #1c1e21;
      --text-main: #f1f1f1;
      --accent: #4CAF50;
      --warn: #f44336;
      --logoff: #ff9800;
      --input-dark: #2a2d30;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }
    body { background: var(--bg-dark); color: var(--text-main); padding: 30px 20px; }
    .container { max-width: 1000px; margin: auto; }
    h1 { font-size: 28px; text-align: center; margin-bottom: 30px; }
    .panel { background: var(--section-light); padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25); }
    .panel h2 { font-size: 20px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 6px; }
    input, select, button { width: 100%; padding: 8px 12px; margin: 6px 0 12px; border: none; border-radius: 6px; font-size: 15px; background: var(--input-dark); color: var(--text-main); }
    button { background: var(--accent); font-weight: 600; cursor: pointer; transition: background 0.3s; margin-top: 10px; }
    button:hover { background: #3e9144; }
    button.warn { background: var(--warn); }
    button.warn:hover { background: #e53935; }
    label { display: block; margin-top: 12px; margin-bottom: 4px; font-weight: 600; }
    .dual-row { display: flex; gap: 10px; }
    .dual-row > * { flex: 1; }
    #capacityWarning { display: none; font-size: 13px; background: #333; padding: 6px 10px; border-left: 4px solid var(--warn); margin-top: 8px; border-radius: 4px; }
    #bEstimate { background: #252729; color: #ccc; opacity: 0.85; cursor: not-allowed; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <h1>Master Admin Panel</h1>
  <div id="authPanel" class="panel">
    <h2>Admin Access</h2>
    <p>Please enter the admin password to unlock this page.</p>
    <input type="password" id="adminPass" placeholder="Enter password..." />
    <button onclick="verifyAdmin()">Unlock</button>
    <p id="authError" class="warn hidden">Incorrect password.</p>
  </div>

  <div id="mainContent" class="hidden">
    <div class="panel">
      <h2>Rota & Break Manager</h2>
      <label for="rotaDate">Select Date:</label>
      <input type="date" id="rotaDate" />
      <div id="driverRotaList"></div>
    </div>

    <div class="panel">
      <h2>Manual Booking</h2>
      <label>Pickup address:</label><input id="bPickup" type="text" placeholder="Enter pickup address" />
      <label>Drop-off address:</label><input id="bDropoff" type="text" placeholder="Enter drop-off address" />
      <div class="dual-row">
        <div><label>Passengers:</label><select id="bPassengers"><option disabled selected>Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
        <div><label>Luggage:</label><select id="bLuggage"><option disabled selected>Select</option><option>None</option><option>Small</option><option>Medium</option><option>Large</option></select></div>
      </div>
      <p id="capacityWarning" class="warn hidden">Limited luggage space. Only No or Small allowed if 5+ passengers.</p>
      <div class="dual-row">
        <div><label>Date:</label><input id="bDate" type="date" /></div>
        <div><label>Time:</label><input id="bTime" type="time" /></div>
      </div>
      <label>Distance & Fare:</label><input id="bEstimate" type="text" disabled placeholder="Distance and fare will appear..." />
      <label>Assigned Driver:</label><input id="bAssignedDriver" type="text" disabled placeholder="Searching for driver..." />
      <label>Pets:</label><input id="bPets" type="text" value="No" disabled />
      <div class="dual-row">
        <input id="bName" type="text" placeholder="Customer name" />
        <input id="bPhone" type="text" placeholder="Phone number" />
      </div>
      <label>Additional info:</label><input id="bExtra" type="text" placeholder="Optional instructions" />
      <button id="addBookingBtn" onclick="addManualBooking()" disabled>Add Booking</button>
    </div>

    <div class="panel">
      <h2>Live Bookings</h2>
      <div id="liveBookingsList"><p>Loading...</p></div>
    </div>
  </div>
</div>

<script>
// Firebase
const firebaseConfig = { /* your config here */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const authPanel = document.getElementById("authPanel");
const mainContent = document.getElementById("mainContent");
const errorText = document.getElementById("authError");

if (localStorage.getItem("adminAccessUntil") > Date.now()) unlockAdmin();

function verifyAdmin() {
  const input = document.getElementById("adminPass").value.trim();
  db.ref("masterRotaPassword/password").once("value").then(snap => {
    if (snap.val() === input) {
      localStorage.setItem("adminAccessUntil", Date.now() + 900000);
      unlockAdmin();
    } else errorText.classList.remove("hidden");
  });
}
function unlockAdmin() { authPanel.classList.add("hidden"); mainContent.classList.remove("hidden"); }

// Rota & Breaks
document.getElementById("rotaDate").addEventListener("change", () => {
  const date = document.getElementById("rotaDate").value;
  if (!date) return;
  db.ref("drivers").once("value").then(snap => {
    const drivers = snap.val() || {};
    const container = document.getElementById("driverRotaList");
    container.innerHTML = "";
    for (const key in drivers) {
      const driver = drivers[key];
      const block = document.createElement("div");
      block.className = "panel";
      block.innerHTML = `
        <p><strong>${driver.name}</strong> – ${driver.vehicle.make} ${driver.vehicle.model}</p>
        <label>Start:</label><input id="start-${driver.doorCard}" type="time" />
        <label>End:</label><input id="end-${driver.doorCard}" type="time" />
        <label>Break From:</label><input id="breakFrom-${driver.doorCard}" type="time" />
        <label>Break To:</label><input id="breakTo-${driver.doorCard}" type="time" />
        <button onclick="saveRota('${driver.doorCard}')">Save</button>`;
      container.appendChild(block);
      db.ref(`rota/${driver.doorCard}/${date}`).once("value").then(rotaSnap => {
        const rota = rotaSnap.val();
        if (rota) {
          document.getElementById(`start-${driver.doorCard}`).value = rota.start || "";
          document.getElementById(`end-${driver.doorCard}`).value = rota.end || "";
        }
      });
      db.ref(`breaks/${driver.doorCard}/${date}`).once("value").then(breakSnap => {
        const brk = breakSnap.val();
        if (brk) {
          document.getElementById(`breakFrom-${driver.doorCard}`).value = brk.from || "";
          document.getElementById(`breakTo-${driver.doorCard}`).value = brk.to || "";
        }
      });
    }
  });
});

function saveRota(doorCard) {
  const date = document.getElementById("rotaDate").value;
  const start = document.getElementById(`start-${doorCard}`).value;
  const end = document.getElementById(`end-${doorCard}`).value;
  const breakFrom = document.getElementById(`breakFrom-${doorCard}`).value;
  const breakTo = document.getElementById(`breakTo-${doorCard}`).value;
  if (start && end) db.ref(`rota/${doorCard}/${date}`).set({ start, end });
  if (breakFrom && breakTo) db.ref(`breaks/${doorCard}/${date}`).set({ from: breakFrom, to: breakTo });
  else db.ref(`breaks/${doorCard}/${date}`).remove();
  alert("Shift saved.");
}

// === LIVE BOOKINGS DISPLAY ===
const liveBookingsList = document.getElementById("liveBookingsList");
db.ref("bookings").on("value", snapshot => {
  const bookings = snapshot.val() || {};
  liveBookingsList.innerHTML = "";
  Object.entries(bookings).reverse().forEach(([key, booking]) => {
    const div = document.createElement("div");
    div.className = "panel";
    div.innerHTML = `
      <p><strong>${booking.name}</strong> | ${booking.pickupDate || "?"} ${booking.pickupTime || "?"}</p>
      <p>${booking.pickup} → ${booking.dropoff}</p>
      <p><strong>Passengers:</strong> ${booking.passengers} | <strong>Luggage:</strong> ${booking.luggage}</p>
      <p><strong>Driver:</strong> ${booking.claimedBy || "Unassigned"}</p>
      <p><strong>Fare:</strong> £${booking.fare || "N/A"}</p>
      <button class="warn" onclick="cancelBooking('${key}')">Cancel Booking</button>`;
    liveBookingsList.appendChild(div);
  });
});

function cancelBooking(id) {
  if (confirm("Cancel this booking?")) {
    db.ref("bookings/" + id).remove().then(() => alert("Booking cancelled."));
  }
}

// === ADDRESS AUTOCOMPLETE & COORDINATES ===
let pickupCoords = null, dropoffCoords = null, latestFare = null;
const pickupInput = document.getElementById("bPickup");
const dropoffInput = document.getElementById("bDropoff");
const dateInput = document.getElementById("bDate");
const timeInput = document.getElementById("bTime");
const estimateField = document.getElementById("bEstimate");

setupAutocomplete(pickupInput, true);
setupAutocomplete(dropoffInput, false);
dateInput.addEventListener("change", updateEstimate);
timeInput.addEventListener("change", updateEstimate);

function setupAutocomplete(input, isPickup) {
  const auto = new google.maps.places.Autocomplete(input, { componentRestrictions: { country: 'gb' } });
  auto.addListener("place_changed", () => {
    const place = auto.getPlace();
    if (place.geometry && place.geometry.location) {
      const coords = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
      if (isPickup) pickupCoords = coords; else dropoffCoords = coords;
      updateEstimate();
    }
  });
}

function updateEstimate() {
  if (!pickupCoords || !dropoffCoords) { estimateField.value = ""; return; }
  if (!dateInput.value || !timeInput.value) { estimateField.value = "Select date and time."; return; }

  const directionsService = new google.maps.DirectionsService();
  directionsService.route({ origin: pickupCoords, destination: dropoffCoords, travelMode: 'DRIVING' }, (response, status) => {
    if (status !== "OK" || !response.routes.length) {
      estimateField.value = "Could not calculate route.";
      latestFare = null;
      return;
    }
    const leg = response.routes[0].legs[0];
    const distanceMeters = leg.distance.value;
    const distanceKm = (distanceMeters / 1000).toFixed(2);

    let baseFare = 4.20, stepFare = 0.30;
    const dt = new Date(`${dateInput.value}T${timeInput.value}`);
    const hr = dt.getHours(), month = dt.getMonth() + 1, day = dt.getDate();

    if ((month === 12 && (day === 24 || day === 31) && hr >= 19) || (dt.getDay() === 0 && hr >= 19)) {
      baseFare = 8.40; stepFare = 0.60;
    } else if (hr >= 23 || hr < 7) {
      baseFare = 6.30; stepFare = 0.40;
    }

    let fare = baseFare;
    const excessMeters = distanceMeters - 1609;
    if (excessMeters > 0) fare += Math.ceil(excessMeters / 161) * stepFare;

    latestFare = fare.toFixed(2);
    estimateField.value = `Distance: ${distanceKm} km | Fare: £${latestFare}`;

    autoAssignDriver();
  });
}

const passengersDropdown = document.getElementById("bPassengers");
const luggageSelect = document.getElementById("bLuggage");
const capacityWarning = document.getElementById("capacityWarning");
passengersDropdown.addEventListener("change", () => {
  if (parseInt(passengersDropdown.value) >= 5) {
    capacityWarning.style.display = "block";
    luggageSelect.querySelector('option[value="Medium"]').disabled = true;
    luggageSelect.querySelector('option[value="Large"]').disabled = true;
  } else {
    capacityWarning.style.display = "none";
    luggageSelect.querySelector('option[value="Medium"]').disabled = false;
    luggageSelect.querySelector('option[value="Large"]').disabled = false;
  }
});

// === DRIVER AUTO-ASSIGNMENT ===
const assignedDriverField = document.getElementById("bAssignedDriver");
const homeBase = { lat: 54.3794, lng: -2.9056 };
let driverMap = {};

function autoAssignDriver() {
  if (!pickupCoords || !dropoffCoords || !dateInput.value || !timeInput.value) {
    assignedDriverField.value = "Waiting for complete info...";
    return;
  }

  db.ref("drivers").once("value").then(driverSnap => {
    const drivers = driverSnap.val() || {};
    driverMap = {}; // reset
    for (const key in drivers) driverMap[drivers[key].name] = drivers[key].doorCard;

    const availableDrivers = [];
    const rotaDrivers = [];

    const promises = Object.keys(drivers).map(key => {
      const driver = drivers[key];
      return db.ref(`rota/${driver.doorCard}/${dateInput.value}`).once("value").then(rotaSnap => {
        const rota = rotaSnap.val();
        if (rota && rota.start && rota.end) {
          rotaDrivers.push(driver);
          return checkDiaryAvailability(driver, dateInput.value, timeInput.value).then(free => {
            if (free) {
              return checkTravelTime(driver, pickupCoords, dateInput.value, timeInput.value).then(reachable => {
                if (reachable) availableDrivers.push(driver);
              });
            }
          });
        }
      });
    });

    Promise.all(promises).then(() => {
      if (availableDrivers.length) {
        const driver = availableDrivers[0];
        assignedDriverField.value = `${driver.name} – ${driver.vehicle.make} ${driver.vehicle.model}, ${driver.vehicle.color} – ${driver.vehicle.registration} – ${driver.vehicle.seats} Seats`;
      } else {
        assignedDriverField.value = "No driver available at requested time.";
        findNextAvailableSlotAcrossDrivers(rotaDrivers, dateInput.value, timeInput.value);
      }
    });
  });
}

// === CHECK IF DRIVER FREE (NO DIARY CONFLICT) ===
function checkDiaryAvailability(driver, dateVal, timeVal) {
  return new Promise(resolve => {
    const door = driver.doorCard;
    const minutes = timeStringToMinutes(timeVal);

    db.ref(`rota/${door}/${dateVal}`).once("value").then(rotaSnap => {
      const rota = rotaSnap.val();
      if (!rota || !rota.start || !rota.end) return resolve(false);

      const start = timeStringToMinutes(rota.start);
      const end = timeStringToMinutes(rota.end);
      if (minutes < start || minutes > end) return resolve(false);

      db.ref(`breaks/${door}/${dateVal}`).once("value").then(breakSnap => {
        const brk = breakSnap.val();
        if (brk && brk.from && brk.to) {
          const breakStart = timeStringToMinutes(brk.from);
          const breakEnd = timeStringToMinutes(brk.to);
          if (minutes >= breakStart && minutes <= breakEnd) return resolve(false);
        }

        db.ref("bookings").orderByChild("claimedDoor").equalTo(door).once("value").then(async bookingsSnap => {
          const bookings = bookingsSnap.val() || {};
          for (const id in bookings) {
            const b = bookings[id];
            if (b.pickupDate === dateVal) {
              const bMinutes = timeStringToMinutes(b.pickupTime);
              let duration = 30;
              if (b.dropoffCoords && b.pickup && b.dropoff) {
                duration = await estimateJourneyDuration(b.pickup, b.dropoff);
              }
              const bEnd = bMinutes + (duration / 60) + 10;
              if (minutes < bEnd) return resolve(false);
            }
          }
          resolve(true);
        });
      });
    });
  });
}

// === CHECK TRAVEL TIME TO PICKUP ===
function checkTravelTime(driver, pickupLoc, dateVal, timeVal) {
  return new Promise(resolve => {
    db.ref("bookings").orderByChild("claimedDoor").equalTo(driver.doorCard).once("value").then(bookingSnap => {
      const bookings = bookingSnap.val() || {};
      let latest = null;

      for (const id in bookings) {
        const b = bookings[id];
        if (b.pickupDate === dateVal) {
          if (!latest || timeStringToMinutes(b.pickupTime) > timeStringToMinutes(latest.pickupTime)) {
            latest = b;
          }
        }
      }

      let from = homeBase;
      if (latest && latest.dropoffCoords) from = latest.dropoffCoords;

      const service = new google.maps.DistanceMatrixService();
      service.getDistanceMatrix({
        origins: [from],
        destinations: [pickupLoc],
        travelMode: google.maps.TravelMode.DRIVING
      }, (res, status) => {
        if (status !== "OK" || !res.rows.length || !res.rows[0].elements.length) {
          resolve(false);
          return;
        }
        const travelSeconds = res.rows[0].elements[0].duration.value;
        const travelMinutes = (travelSeconds + 600) / 60; // +10 min buffer
        const readyMinutes = latest ? (timeStringToMinutes(latest.pickupTime) + travelMinutes) : travelMinutes;
        resolve(timeStringToMinutes(timeVal) >= readyMinutes);
      });
    });
  });
}

// === FIND NEXT AVAILABLE SLOT ACROSS DRIVERS ===
function findNextAvailableSlotAcrossDrivers(drivers, dateVal, startTime) {
  const searches = drivers.map(driver => {
    return findNextAvailableSlot(driver, dateVal, startTime).then(nextTime => ({ driver, nextTime }));
  });

  Promise.all(searches).then(results => {
    const valid = results.filter(r => r.nextTime);
    if (valid.length) {
      valid.sort((a, b) => timeStringToMinutes(a.nextTime) - timeStringToMinutes(b.nextTime));
      const best = valid[0];
      if (confirm(`Closest slot: ${best.nextTime} with ${best.driver.name}.\n\nUpdate booking time?`)) {
        document.getElementById("bTime").value = best.nextTime;
        updateEstimate();
      }
    } else {
      alert("No available slots today. Please choose another time.");
    }
  });
}

// === FIND NEXT AVAILABLE TIME FOR SINGLE DRIVER ===
function findNextAvailableSlot(driver, dateVal, startFrom) {
  return new Promise(async (resolve) => {
    let attempt = timeStringToMinutes(startFrom);
    const rotaSnap = await db.ref(`rota/${driver.doorCard}/${dateVal}`).once("value");
    const rota = rotaSnap.val();
    if (!rota || !rota.start || !rota.end) return resolve(null);

    const start = timeStringToMinutes(rota.start);
    const end = timeStringToMinutes(rota.end);
    if (attempt > end) return resolve(null);

    while (attempt <= end) {
      const h = String(Math.floor(attempt / 60)).padStart(2, '0');
      const m = String(attempt % 60).padStart(2, '0');
      const attemptTime = `${h}:${m}`;

      const free = await checkDiaryAvailability(driver, dateVal, attemptTime);
      if (free) {
        const reachable = await checkTravelTime(driver, pickupCoords, dateVal, attemptTime);
        if (reachable) return resolve(attemptTime);
      }
      attempt += 5;
    }
    resolve(null);
  });
}

// === MANUAL BOOKING CREATION ===
function addManualBooking() {
  const name = document.getElementById("bName").value.trim();
  const phone = document.getElementById("bPhone").value.trim();
  const pickup = pickupInput.value.trim();
  const dropoff = dropoffInput.value.trim();
  const date = dateInput.value;
  const time = timeInput.value;
  const passengers = passengersDropdown.value;
  const luggage = luggageSelect.value;
  const pets = "No";
  const extra = document.getElementById("bExtra").value.trim();
  const assigned = document.getElementById("bAssignedDriver").value.trim();

  if (!name || !phone || !pickup || !dropoff || !date || !time || !passengers || !luggage) {
    alert("Complete all fields.");
    return;
  }

  if (!latestFare) {
    alert("Waiting for fare estimate...");
    return;
  }

  let claimedBy = "unassigned", claimedDoor = "unassigned";
  if (assigned && !assigned.includes("No driver")) {
    const driverName = assigned.split("–")[0].trim();
    const doorCard = driverMap[driverName];
    if (doorCard) {
      claimedBy = driverName;
      claimedDoor = doorCard;
    }
  }

  const newBooking = {
    name, phone, pickup, dropoff, pickupDate: date, pickupTime: time,
    passengers, luggage, pets, extra, claimedBy, claimedDoor,
    fare: latestFare, dropoffCoords
  };

  const key = db.ref("bookings").push().key;
  db.ref("bookings/" + key).set(newBooking).then(() => {
    alert("Booking added successfully.");
    document.querySelectorAll(".panel input, .panel select").forEach(el => {
      if (!["bPets", "bAssignedDriver", "bEstimate"].includes(el.id)) el.value = "";
    });
    passengersDropdown.value = "";
    luggageSelect.value = "";
    capacityWarning.style.display = "none";
    assignedDriverField.value = "Searching...";
  });
}

// === UTIL: TIME TO MINUTES ===
function timeStringToMinutes(t) {
  const p = t.split(":");
  return parseInt(p[0]) * 60 + parseInt(p[1]);
}

// === ESTIMATE JOURNEY DURATION ===
function estimateJourneyDuration(from, to) {
  return new Promise(resolve => {
    const service = new google.maps.DistanceMatrixService();
    service.getDistanceMatrix({ origins: [from], destinations: [to], travelMode: 'DRIVING' }, (res, status) => {
      if (status !== "OK" || !res.rows.length || !res.rows[0].elements.length) {
        resolve(1800);
        return;
      }
      resolve(res.rows[0].elements[0].duration.value);
    });
  });
}

// === LIVE BOOKINGS DISPLAY ===
const liveBookingsList = document.getElementById("liveBookingsList");

db.ref("bookings").on("value", snap => {
  const bookings = snap.val() || {};
  liveBookingsList.innerHTML = "";

  Object.entries(bookings).reverse().forEach(([key, booking]) => {
    const div = document.createElement("div");
    div.className = "panel";
    div.innerHTML = `
      <p><strong>${booking.name}</strong> | ${booking.pickupDate || "?"} ${booking.pickupTime || "?"}</p>
      <p>${booking.pickup} → ${booking.dropoff}</p>
      <p><strong>Passengers:</strong> ${booking.passengers} | <strong>Luggage:</strong> ${booking.luggage} | <strong>Pets:</strong> ${booking.pets}</p>
      <p><strong>Driver:</strong> ${booking.claimedBy || "Unassigned"}</p>
      <p><strong>Notes:</strong> ${booking.extra || "<em>None</em>"}</p>
      <p><strong>Fare:</strong> £${booking.fare || "N/A"}</p>
      <button class="warn" onclick="cancelBooking('${key}')">Cancel Booking</button>
    `;
    liveBookingsList.appendChild(div);
  });
});

// === CANCEL BOOKING ===
function cancelBooking(id) {
  if (confirm("Are you sure you want to cancel this booking?")) {
    db.ref("bookings/" + id).remove().then(() => {
      alert("Booking cancelled.");
    });
  }
}

// === SMALL FINAL CORRECTION: UPDATE ESTIMATE FUNCTION ===
function updateEstimate() {
  updateEstimateDisplay(); // simple alias to keep naming consistent
}
  
</script>
</body>
</html>
